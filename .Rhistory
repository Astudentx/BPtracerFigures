P3 <- MRG_ppm_type_ab_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MRG types")+scale_fill_npg()+scale_y_continuous(expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P3
# 物种溯源
attach(MRG_ppm_source_P)
LorMe04::community_plot(plotprefix="MRG_ppm_source_P",inputframe=MRG_ppm_source_P,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P4 <- MRG_ppm_source_P_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MRG hosts")+scale_fill_d3()+scale_y_continuous(expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P4
# VFDB__________________________
# Type种类
LorMe04::community_plot(plotprefix="VFDB_ppm_type_ab",inputframe=VFDB_ppm_type_ab,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P5 <- VFDB_ppm_type_ab_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("VF types")+scale_fill_npg()+scale_y_continuous(expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P5
# 物种溯源
attach(VFDB_ppm_source_P)
LorMe04::community_plot(plotprefix="VFDB_ppm_source_P",inputframe=VFDB_ppm_source_P,n=8,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P6 <- VFDB_ppm_source_P_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("VF hosts")+scale_fill_d3()+scale_y_continuous(expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P6
# SG__________________________
# Type种类
LorMe04::community_plot(plotprefix="SG_ppm_type_ab",inputframe=SG_ppm_type_ab,n=3,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P7 <- SG_ppm_type_ab_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("SG types")+scale_fill_npg()+scale_y_continuous(expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P7
# 物种溯源
attach(SG_ppm_source_P)
LorMe04::community_plot(plotprefix="SG_ppm_source_P",inputframe=SG_ppm_source_P,n=3,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P8 <- SG_ppm_source_P_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("SG hosts")+scale_fill_d3()+scale_y_continuous(expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P8
# 按照设计的样式去拼图
design1 <- c("0
1
2
3
4
5
6
7
8
9
")
library(patchwork)
final_ab <- PA+PA1+P1+P2+P3+P4+P5+P6+P7+P8+
plot_layout(design = design1)+
plot_annotation(tag_levels = "a")&theme(plot.margin = ggplot2::margin(0, .1, 0, .1),)&
theme(plot.title = element_text(face = "bold"),
plot.tag = element_text(face = "bold"))
final_ab
ggsave(final_ab,filename = "03.figure/S_other_gene_abnew.pdf",height = 16,width = 10)
ggsave(final_ab,filename = "03.figure/S_other_gene_abnew.tiff",height = 16,width = 10)
# ARG__________________________
# Type种类
LorMe04::community_plot(plotprefix="ARG_ppm_type_re",inputframe=ARG_ppm_type_re,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P0 <- ARG_ppm_type_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("ARG types")+scale_fill_npg()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P0
# 物种溯源
attach(ARG_ppm_source_P)
LorMe04::community_plot(plotprefix="ARG_ppm_source_P_re",inputframe=ARG_ppm_source_P_re,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P0_1 <- ARG_ppm_source_P_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("ARG hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P0_1
# MGE__________________________
# Type种类
LorMe04::community_plot(plotprefix="MGE_ppm_type_re",inputframe=MGE_ppm_type_re,n=4,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P1 <- MGE_ppm_type_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MGE types")+scale_fill_npg()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P1
# 物种溯源
attach(MGE_ppm_source_P)
LorMe04::community_plot(plotprefix="MGE_ppm_source_P_re",inputframe=MGE_ppm_source_P_re,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P2 <- MGE_ppm_source_P_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MGE hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P2
# MGE__________________________
# Type种类
LorMe04::community_plot(plotprefix="MGE_ppm_type_re",inputframe=MGE_ppm_type_re,n=4,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P1 <- MGE_ppm_type_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MGE types")+scale_fill_npg()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P1
# 物种溯源
attach(MGE_ppm_source_P)
LorMe04::community_plot(plotprefix="MGE_ppm_source_P_re",inputframe=MGE_ppm_source_P_re,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P2 <- MGE_ppm_source_P_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MGE hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P2
# MRG__________________________
# Type种类
LorMe04::community_plot(plotprefix="MRG_ppm_type_re",inputframe=MRG_ppm_type_re,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P3 <- MRG_ppm_type_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MRG types")+scale_fill_npg()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P3
# 物种溯源
attach(MRG_ppm_source_P)
LorMe04::community_plot(plotprefix="MRG_ppm_source_P_re",inputframe=MRG_ppm_source_P_re,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P4 <- MRG_ppm_source_P_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("MRG hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P4
# VFDB__________________________
# Type种类
LorMe04::community_plot(plotprefix="VFDB_ppm_type_re",inputframe=VFDB_ppm_type_re,n=9,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P5 <- VFDB_ppm_type_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("VF types")+scale_fill_npg()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P5
# 物种溯源
attach(VFDB_ppm_source_P)
LorMe04::community_plot(plotprefix="VFDB_ppm_source_P_re",inputframe=VFDB_ppm_source_P_re,n=8,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P6 <- VFDB_ppm_source_P_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("VF hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P6
# SG__________________________
# Type种类
LorMe04::community_plot(plotprefix="SG_ppm_type_re",inputframe=SG_ppm_type_re,n=3,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P7 <- SG_ppm_type_re_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("SG types")+scale_fill_npg()+scale_y_continuous(expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P7
# 物种溯源
attach(SG_ppm_source_P)
LorMe04::community_plot(plotprefix="SG_ppm_source_P",inputframe=SG_ppm_source_P,n=3,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P8 <- SG_ppm_source_P_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("VF hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P8
# 按照设计的样式去拼图
design1 <- c("0
1
2
3
4
5
6
7
8
9
")
library(patchwork)
final_re <- P0+P0_1+P1+P2+P3+P4+P5+P6+ P7+P8+
plot_layout(design = design1)+
plot_annotation(tag_levels = "a")&theme(plot.margin = ggplot2::margin(0, .1, 0, .1, "cm"),)&
theme(plot.title = element_text(face = "bold"),
plot.tag = element_text(face = "bold"))
final_re
ggsave(final_re,filename = "03.figure/S_other_gene_renew.pdf", height = 16,width = 10)
ggsave(final_re,filename = "03.figure/S_other_gene_renew.tiff",height = 16,width = 10)
P8 <- SG_ppm_source_P_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("SG hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P8
P8 <- SG_ppm_source_P_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("SG hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P8
# 按照设计的样式去拼图
design1 <- c("0
1
2
3
4
5
6
7
8
9
")
library(patchwork)
final_re <- P0+P0_1+P1+P2+P3+P4+P5+P6+ P7+P8+
plot_layout(design = design1)+
plot_annotation(tag_levels = "a")&theme(plot.margin = ggplot2::margin(0, .1, 0, .1, "cm"),)&
theme(plot.title = element_text(face = "bold"),
plot.tag = element_text(face = "bold"))
final_re
ggsave(final_re,filename = "03.figure/S_other_gene_renew.pdf", height = 16,width = 10)
ggsave(final_re,filename = "03.figure/S_other_gene_renew.tiff",height = 16,width = 10)
LorMe04::community_plot(plotprefix="SG_ppm_source_P",inputframe=SG_ppm_source_P_re,n=3,inputformat=2,groupframe=group_env,treatlocation=2,replocation=3)
P8 <- SG_ppm_source_P_barplot+facet_wrap(~Group,scales = "free_x",nrow = 1)+scale_x_discrete()+xlab("")+ylab("SG hosts")+scale_fill_d3()+scale_y_continuous(labels = scales::percent,expand = c(0,0)) +theme_jgfbw()+theme(legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+theme(panel.margin.x=unit(0.2, "lines"))+ guides(fill=guide_legend(nrow =1))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P8
final_re <- P0+P0_1+P1+P2+P3+P4+P5+P6+ P7+P8+
plot_layout(design = design1)+
plot_annotation(tag_levels = "a")&theme(plot.margin = ggplot2::margin(0, .1, 0, .1, "cm"),)&
theme(plot.title = element_text(face = "bold"),
plot.tag = element_text(face = "bold"))
ggsave(final_re,filename = "03.figure/S_other_gene_renew.pdf", height = 16,width = 10)
ggsave(final_re,filename = "03.figure/S_other_gene_renew.tiff",height = 16,width = 10)
final_bio_risk
# Biopollutome --------------------------------------------------------------
load("02.datasave/02.HiIndex.Rdata")
# 功能基因溯源分析表
attach(final_bio_risk)
str(final_bio_risk)
View(final_bio_risk)
View(Pangenome_stat_final)
View(GCF.use)
View(refseq_240519_tax)
View(refseq_240519_usedInfoRaw)
View(refseq_240519_allInfoRaw)
View(refseq_240519_usedGCFtax)
View(refseq_240519_usedGCFtax)
View(refseq_240519_usedtax)
View(refseq_240519_usedtax)
View(refseq_240519_usedGCFtax)
View(refseq_240519_usedInfoRaw)
View(refseq_240519_usedInfoRaw)
View(refseq_240519_usedtax)
View(refseq_240519_usedGCFtax)
View(refseq_240519_usedtax)
load("01.rawdata/UniPathogenDB/UniPathogenDB.Rdata")
# Chunk 1
path <- getwd()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = path)
library(data.table)
library(magrittr)
library(bptracer)
library(dplyr)
load("01.rawdata/UniPathogenDB/UniPathogenDB.Rdata")
# Chunk 2
# 读取taxnonmy信息
taxid <- read.delim(file = "01.rawdata/Refseq_240519/refseq_240519_taxid.taxonomy.txt")
taxidsubspecies <-  read.delim(file = "/Users/astudentx/Linux/database/refseq_240519_taxonomy/refseq_240519_taxid.taxonomySubspecies.txt",check.names = F)
speciestaxid <- read.delim(file = "01.rawdata/Refseq_240519/refseq_240519_speciestaxid.taxonomy.txt")
speciestaxidsubspecies <-  read.delim(file = "/Users/astudentx/Linux/database/refseq_240519_taxonomy/refseq_240519_speciestaxid.taxonomySubspecies.txt",check.names = F)
df1 <- read.delim(file = "/Users/astudentx/Linux/database/refseq_240519_taxonomy/refseq_240519_speciestaxid.taxonomyLineage.txt",check.names = F)
df2 <- taxonomy_combine(inputtble  = df1,col = c("Kindom","Phylum","Class","Order","Family","Genus","Species"),newcolname = "taxonomy")
df3 <- taxonomy_combine(inputtble  = df2,col = c("Kindom.ID","Phylum.ID","Class.ID","Order.ID","Family.ID","Genus.ID","Species.ID"),newcolname="Lineage")
speciestaxidLineage <- taxonomy_prefix(inputtble = df3,colnames  = c("Kindom","Phylum","Class","Order","Family","Genus","Species"),action = "remove",level =c("k", "p", "c", "o", "f", "g", "s"))
speciestaxidLineage <- data.frame(lapply(speciestaxidLineage, as.character), stringsAsFactors = FALSE)
# 导入下载的所有基因组数据
GCF_ID <- read.delim(file = "01.rawdata/Refseq_240519/refseq_ftp_downlaod.ID2.txt",header = F);colnames(GCF_ID) <- c("assembly_accession","download_ID")
# 读入assembly_summary_refseq_bacteria,fread可能会丢弃空行
refseq_raw <- read.delim(file = "01.rawdata/Refseq_240519/refseq_240519_assembly_summary.txt",sep = "\t",check.names = F,fill = T,skip = 1,quote = "\t")
colnames(refseq_raw)[1] <- "assembly_accession"
refseq_raw <- refseq_raw[!(refseq_raw$assembly_accession == "#assembly_accession"), ]
refseq_raw <- left_join(refseq_raw,speciestaxidLineage,by=c("species_taxid"="species_taxid"))
# 已经下载的genomes
refseq_raw_download <- refseq_raw[which(refseq_raw$assembly_accession %in% GCF_ID$assembly_accession),] %>% unique()
# 无法下载的genomes
refseq_raw_nondownload <- refseq_raw[which(!refseq_raw$assembly_accession %in% GCF_ID$assembly_accession),] %>% unique()
unique(refseq_raw_download$assembly_accession) %>% length()
GCF_mutiID <- uniq_c(refseq_raw_download$assembly_accession) %>% filter(Count>1)
# 筛选已经下载的所有GCFID，可以下载的GCF文件一共353585
taxlist1 <- c("Kindom","Phylum","Class","Order","Family","Genus","Species")
taxlist2 <- c("Kindom.ID","Phylum.ID","Class.ID","Order.ID","Family.ID","Genus.ID","Species.ID")
colnames(refseq_raw_download)
temp1 <- refseq_raw_download %>% select(assembly_accession,taxid,species_taxid,all_of(taxlist1),all_of(taxlist2))
# 合并GCF_taxonomy,17个GCF无法获取GCFID信息
temp1$Kindom[is.na(temp1$Kindom)] %>% length()
# 对这17个物种进行标记，ID是否被NCBI所删除
temp1$ID_Delet_by_NCBI <- "FALSE"
temp1$ID_Delet_by_NCBI[which(is.na(temp1$kindom))] <- "TURE"
temp1 <- arrange(temp1,ID_Delet_by_NCBI)
# 合并获取最终的GCF_taxonomy
temp2 <- left_join(GCF_ID,temp1)
# 正好是存在多个taxID属于不同species
uniq_c(temp2$species_taxid) %>% nrow()
uniq_c(temp2$species) %>% nrow()
uniq_c(temp2$ID_Delet_by_NCBI)
refseq_240519_downloadGCFtax <- temp2
refseq_240519_downloadInfoRaw <- refseq_raw_download
refseq_240519_allInfoRaw<-  refseq_raw
refseq_240519_tax <- speciestaxidsubspecies
# 输出数据
# write.table(temp3,file = "01.rawdata/Refseq_240519/refseq_240519_GCFtaxnonmy.txt",col.names = T,row.names = F,sep = "\t",quote = F)
# Chunk 3
# 使用的所有序列
refseq_kraken2_all <- readxl::read_xlsx(path = "01.rawdata/Refseq_kraken2/refseq_240519_forKraken2.xlsx",sheet = 1) %>% .[,1] %>% as.data.frame()
colnames(refseq_kraken2_all)[1] <- "assembly_accession"
nrow(refseq_kraken2_all)
# 建库所使用的代表性序列
refseq_kraken2_represent <- readxl::read_xlsx(path = "01.rawdata/Refseq_kraken2/refseq_240519_forKraken2.xlsx",sheet = 2) %>% .[,1] %>% as.data.frame()
colnames(refseq_kraken2_represent)[1] <- "assembly_accession"
nrow(refseq_kraken2_represent)
# 所有的代表性序列都是可以被发现的物种
refseq_kraken2_represent_GCFtax<- refseq_240519_downloadGCFtax[which(refseq_240519_downloadGCFtax$assembly_accession %in% refseq_kraken2_represent$assembly_accession),]
# 所有物种49803，代表性物种只有18626
refseq_240519_allInfoRaw$species_taxid %>% unique() %>% length()
refseq_kraken2_represent_GCFtax$ID_Delet_by_NCBI %>% uniq_c()
# Chunk 4
df1 <- refseq_240519_downloadInfoRaw[which(refseq_240519_downloadInfoRaw$refseq_category=="representative genome"),]
df2 <- refseq_240519_allInfoRaw[which(refseq_240519_allInfoRaw$refseq_category=="representative genome"),]
uniq_c(df1$organism_name)
# 补充大肠杆菌和肺炎克雷伯
attach(refseq_240519_downloadInfoRaw)
proGenome <- readxl::read_xlsx("01.rawdata/ProGenomeSelect/ProGenomeRepresentivate.xlsx")
proGenome_S <- refseq_240519_downloadInfoRaw[which(refseq_240519_downloadInfoRaw$biosample %in% proGenome$Biosample ),]
# write.csv(proGenome_S,"01.rawdata/ProGenomeSelect/ProGenomeRepresentivate_Select.csv",quote = F,row.names  = F)
proGenome_F <- proGenome[which(!proGenome$Biosample %in% refseq_240519_downloadInfoRaw$biosample ),]
proGenome_F2 <- proGenome[which(proGenome$Biosample %in% refseq_240519_downloadInfoRaw$biosample ),]
# Chunk 5
# 用于构建Pangenomes的序列名称，已经经过初步的筛选了
GCF.use <- read.delim(file = "01.rawdata/Refseq_240519/final.GCF.used.list",header = F)
colnames(GCF.use) <- c("assembly_accession","species_taxid")
refseq_240519_usedGCFtax <- refseq_240519_downloadGCFtax[which(refseq_240519_downloadGCFtax$assembly_accession %in% GCF.use$assembly_accession ),]
refseq_240519_usedInfoRaw <- refseq_240519_downloadInfoRaw[which(refseq_240519_downloadInfoRaw$assembly_accession %in% GCF.use$assembly_accession ),]
refseq_240519_usedtax <- refseq_240519_usedGCFtax %>% select(4:18) %>% unique()
dim(GCF.use)
dim(refseq_240519_usedGCFtax)
dim(refseq_240519_usedInfoRaw)
dim(refseq_240519_usedtax)
# Chunk 6
# 组装情况饼图 ------------------------------------------------------------------
Assamble_state <- uniq_c(refseq_240519_usedInfoRaw$assembly_level)
colnames(Assamble_state)[2] <- "Freq"
Assamble_state$percent <- round(Assamble_state$Freq/sum(Assamble_state$Freq),4)*100
Assamble_state$state <- paste0(Assamble_state$ID," ",Assamble_state$percent,"%")
P1 <- ggplot(Assamble_state,aes(x="",y=Freq,fill=state))+
geom_bar(stat="identity")+
coord_polar("y",start=1) +
scale_fill_simpsons()+
# geom_label_repel(color="white",data = Assamble_state,aes(label=percent),show.legend = F)+
# geom_text(aes(label = percent))+
theme_minimal()+
guides(fill=guide_legend(ncol=1)) +
theme(legend.key.size = unit(.8,'cm'))+      #设置图例文字大小
theme(axis.title=element_blank(),
axis.ticks=element_blank(),
axis.text = element_blank(),
legend.title = element_blank(),
# legend.position = c(.5,.03))+
legend.position = "bottom")+
theme(legend.key.size = unit(.3,'cm'))+
theme(panel.margin.x=unit(0.2, "lines"))+
# guides(fill=guide_legend(nrow =2))+
theme(axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank())
P1
ggsave("03.figure/S_RefseqPie.pdf",width = 3,height = 4)
# Refseq组装情况统计
# head(Refseq_tax)
temp <- refseq_240519_usedGCFtax
Refseq_phylum <- uniq_c(temp$Phylum)
colnames(Refseq_phylum)[1] <- "x"
Refseq_phylum$x <- as.character(Refseq_phylum$x)
# Refseq_phylum$x <- factor(Refseq_phylum$x,levels =Refseq_phylum$x )
Refseq_phylum$Freq2 <- Refseq_phylum$Freq
Refseq_phylum$Count2 <- Refseq_phylum$Count
Refseq_phylum_top8 <- LorMe::Top_taxa(input = Refseq_phylum,n = 9,inputformat = 2,outformat = 1 )
Refseq_phylum_top8$Count
P2 <- ggplot(data =Refseq_phylum_top8,aes(x = reorder(x,Count),y = (Count)) )+
geom_col(fill="#F5C045")+
theme_jgfbw()+
# theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5))+
coord_flip()+
xlab("Phylum")+ylab("Counts")
P2
ggsave("03.figure/S_RefseqCol.pdf",width = 3,height = 3)
# Chunk 7
# 导入去除冗余数据
Pangenome_stat  <- read.delim(file = "01.rawdata/Pangenomes/ZYZ.combined.ffn.stat.txt",sep = "\t",check.names = F)
Pangenome_stat$Type <- ifelse(
grepl("cdhit\\.ffn\\.stat\\.txt$", Pangenome_stat$ID), "After cd-hit",
ifelse(grepl("\\.ffn\\.stat\\.txt$", Pangenome_stat$ID), "Before cd-hit", NA)
)
Pangenome_stat$species_taxid <- str_extract(Pangenome_stat$ID, "^[0-9]+")
colnames(Pangenome_stat)[which(colnames(Pangenome_stat)=="Total length")] <- "GeneLength"
colnames(Pangenome_stat)[which(colnames(Pangenome_stat)=="Total number")] <- "GeneNumber"
# 导入使用的CGFID
GCF.use <- read.delim(file = "01.rawdata/Refseq_240519/final.GCF.used.list",header = F)
colnames(GCF.use) <- c("assembly_accession","species_taxid")
attach(GCF.use)
Pangenome_GenomeNumber <- uniq_c(GCF.use$species_taxid)
colnames(Pangenome_GenomeNumber)[2] <- "GenomeNumber"
Pangenome_stat <- left_join(Pangenome_stat,Pangenome_GenomeNumber,by=c("species_taxid"="ID"))
# 计算衰减率
Pangenome_stat_1 <- Pangenome_stat %>% filter(Type=="Before cd-hit")
Pangenome_stat_2 <- Pangenome_stat %>% filter(Type=="After cd-hit")
NewName <- paste0(colnames(Pangenome_stat_2)," cdhit")
colnames(Pangenome_stat_2) <- NewName
uniq_c(Pangenome_stat_2$`species_taxid cdhit`)
colnames(Pangenome_stat_2)[16] <- "species_taxid"
Pangenome_stat_final <- left_join(Pangenome_stat_1,Pangenome_stat_2)
Pangenome_stat_final$reduce_rate <- (Pangenome_stat_final$GeneLength-Pangenome_stat_final$`GeneLength cdhit`)/Pangenome_stat_final$GeneLength
# pangenome state ---------------------------------------------------------
# 泛基因集合基因组大小分布规律
# 基因组集合去冗余衰减率
# 泛基因集合物种们水平组成情况
Pangenome_stat_final$GenomeNumber
ggplot(data =Pangenome_stat_final,aes(x = GenomeNumber,y = log10(GeneLength)) )+
# geom_line(aes(color=variable))+
geom_jitter(alpha=.5,color="#005755")+
ggforce::facet_zoom(xlim=c(10,400),zoom.size = 3,horizontal = F)+
ylab("GeneTotalNum")+theme_bw()
ggplot(data =Pangenome_stat_final,aes(x = GenomeNumber,y = log10(`GeneLength cdhit`)) )+
# geom_line(aes(color=variable))+
geom_jitter(alpha=.5,color="#005755")+
ggforce::facet_zoom(xlim=c(0,200),zoom.size = 3,horizontal = F)+
ylab("PanGeneNumber")+theme_bw()
ggplot(data =Pangenome_stat_final,aes(x = GenomeNumber,y = reduce_rate) )+
# geom_line(aes(color=variable))+
geom_jitter(alpha=.5,color="#005755")+
ggforce::facet_zoom(xlim=c(0,200),zoom.size = 3)+
ylab("Reduce Rate")+theme_bw()
P3 <- ggplot(data =Pangenome_stat,aes(x = GenomeNumber,y = log10(GeneLength)) )+
# geom_line(aes(color=variable))+
geom_jitter(alpha=.8,aes(color=Type),size=.4)+
ggforce::facet_zoom(xlim=c(0,1000),zoom.size = 3,horizontal = F)+
ylab("log10(Numbers of total gene)")+xlab("Number of species genomes in Refseq")+
theme_jgfbw()+
scale_color_manual(values = color_zyz1)+
theme(legend.title = element_blank(),
legend.position = c(.18,.5))+
theme(legend.key.size = unit(0.5, 'lines'))
P3
ggsave(P3,filename = "03.figure/S_PangenomePoint.pdf",height = 3,width = 3)
# histogram of GeneNumber ---------------------------------------------------------------
Pangenome_stat$GeneNumber
P_his <- ggplot(data = Pangenome_stat_final,aes(x = log10(GeneNumber) ))+
# geom_density(fill="#F5C045")+
geom_histogram(bins = 500,fill="#F5C045")+
theme_jgf()+
xlab("log10(Pangenome Gene Number)")
P_his
# histogram of GeneLength ---------------------------------------------------------------
ggplot(data = Pangenome_stat_final,aes(x = log10(GeneLength) ))+
geom_histogram(bins = 500,fill="#F5C045")+
theme_jgf()
# histogram of reduce_rate ---------------------------------------------------------------
ggplot(data = Pangenome_stat_final,aes(x = reduce_rate))+
geom_histogram(bins = 500,fill="#F5C045")+
theme_jgf()
# Chunk 8
head(refseq_240519_usedtax)
head(NewPA_Air)
df1 <- refseq_240519_usedtax
df2 <- df1[df1$Species %in%NewPA_Air$Species, ] %>% cbind(.,pathogen="Pathogen")
df3 <- df1[!(df1$Species %in%NewPA_Air$Species), ] %>% cbind(.,pathogen="Nonpathogen")
df4 <- rbind(df2,df3)
order <- uniq_c(refseq_240519_usedtax$Phylum)[,1]
Pangenome_phylum <- df4 %>% select(Phylum,pathogen) %>% uniq_c_df()
Pangenome_phylum_wide<-spread(Pangenome_phylum,pathogen,Count)
Pangenome_phylum_wide[is.na(Pangenome_phylum_wide)] <- 0
Pangenome_phylum_wide <- Pangenome_phylum_wide[order(-Pangenome_phylum_wide$Nonpathogen),]
# 筛选top9的Phylum
Pangenome_phylum_top   <- Pangenome_phylum_wide[c(1:8),]
Pangenome_phylum_other <- Pangenome_phylum_wide[-c(1:8),]
Pangenome_phylum_other2 <- data.frame(Phylum="Others",
Nonpathogen=sum(Pangenome_phylum_other$Nonpathogen),
Pathogen=sum(Pangenome_phylum_other$Pathogen),check.names = F)
Pangenome_phylum_top_melt <- rbind(Pangenome_phylum_top,Pangenome_phylum_other2) %>% reshape2::melt(.)
# 附图
P4 <- ggplot(data =Pangenome_phylum_top_melt,aes(x = reorder(Phylum,value),y = value ))+
geom_col(aes(fill=variable))+
scale_fill_manual(values = rev(color_zyz2))+
theme_jgfbw()+
# geom_rect(aes(xmin="Cyanobacteria", xmax=Inf,ymin=0, ymax=300),fill='#FF3300',alpha = .005)+
# theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5))+
theme(legend.key.size = unit(.3,'cm'))+      #设置图例文字大小
theme(legend.position = c(.7,.1))+
coord_flip()+
xlab("Phylum")+ylab("Counts")
P4
ggsave(P4,filename = "03.figure/S_PangenomeTopCol.pdf",width = 3,height = 3)
# Chunk 9
design1 <- c("12
34")
library(patchwork)
final <- P1+P2+P3+P4+
plot_layout(design = design1)+
plot_annotation(tag_levels = list(c('a', 'b',"c","d")))&
theme(plot.title = element_text(face = "bold"),
plot.tag = element_text(face = "bold"))
final
final <- plot_spacer()+P2+P3+P4+
plot_layout(design = design1)+
plot_annotation(tag_levels = list(c( 'b',"c","d")))&
theme(plot.title = element_text(face = "bold"),
plot.tag = element_text(face = "bold"))
final
ggsave(filename = "03.figure/S_PangenomeAll.pdf",width = 6,height = 6)
load("01.rawdata/UniPathogenDB/UniPathogenDB.Rdata")
save(
refseq_240519_usedGCFtax,
refseq_240519_usedtax,
refseq_240519_usedInfoRaw,
refseq_240519_allInfoRaw,
Pangenome_stat_final,
file = "02.datasave/00.RefseqDatabase.Rdata")
save(
refseq_240519_usedGCFtax,
refseq_240519_usedtax,
refseq_240519_usedInfoRaw,
Pangenome_stat_final,
file = "02.datasave/00.RefseqDatabase.Rdata")
path <- getwd()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = path)
library(data.table)
library(magrittr)
library(bptracer)
library(dplyr)
load("01.rawdata/UniPathogenDB/UniPathogenDB.Rdata")
