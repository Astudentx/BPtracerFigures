---
title: "01.HiIndex"
author: "yaozhong_zhang"
date: "2025-05-26"
output: html_document
---

```{r}
path <- getwd()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = path)

package <- c('readxl','magrittr',
             'ggtree','reshape2','ggplot2','dplyr','tidyr',
             'readr','purrr','tibble','stringr','forcats',
             'ggplot2','ggsci','ggridges','RColorBrewer','pheatmap',
             'patchwork','ggpubr','zyzPackage','cowplot','ggrepel','networkD3',"ggrepel","caret","vegan")
lapply(package, function(x){library(x, character.only = T)})
```

# æ•°æ®åº“æ•°æ®
```{r}
# è¯»å…¥ç—…åŸèŒæ•°æ®åº“
# ä½¿ç”¨NewPA_Miniè¿›è¡Œåˆ†æ
load("01.rawdata/UniPathogenDB/UniPathogenDB.Rdata")
attach(NewPA_Mini)


# è¯»å…¥åŸºå› ç»„ä¸‹è½½è¡¨æ ¼
load(file = "02.datasave/00.RefseqDatabase.Rdata")
# attach(refseq_240519_usedGCFtax)
HI_tax <- refseq_240519_usedGCFtax %>% select(assembly_accession,taxid,Species.ID)

# è½¬æ¢æˆæ•°å€¼å‹å‘é‡
HI_tax$Species.ID <- as.numeric(HI_tax$Species.ID)
HI_tax$taxid <- as.numeric(HI_tax$taxid)
NewPA_Mini$ID  <- as.numeric(NewPA_Mini$ID )

colnames(HI_tax) <- c("assembly_accession","taxid","speciesid")
HI_tax <- left_join(HI_tax,NewPA_Mini[,c(1,5:7)],by=c("speciesid"="ID"))
HI_tax$Type[is.na(HI_tax$Type)] <- "NonPathogens"
HI_tax$PathogenRiskScore[is.na(HI_tax$PathogenRiskScore)] <- 0

HI_tax_Plant <- HI_tax %>% filter(HI_tax$Type=="Plant")
HI_tax_Animal <- HI_tax %>% filter(HI_tax$Type=="Animal")
HI_tax_Zoonotic <- HI_tax %>% filter(HI_tax$Type=="Zoonotic")
HI_tax_NonPathogens <- HI_tax %>% filter(HI_tax$Type=="NonPathogens")
HI_tax_ESKAPE <- HI_tax[grep(pattern = "ESKAPE",HI_tax$PathogenSource),]
HI_tax_WHO <- HI_tax[grep(pattern = "WHO",HI_tax$PathogenSource),]
HI_tax_Top10PlantPathogens <- HI_tax[grep(pattern = "Top10PlantPathogens",HI_tax$PathogenSource),]


# è¯»å…¥åŠŸèƒ½åŸºå› æ³¨é‡Šæ–‡ä»¶
final_bio <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_select_TY/FunctionalGeneFinal_unique.txt")
final_bio <- final_bio %>%
  mutate(GeneKind = recode(GeneKind,
                           "ARG" = "ARGs",
                           "MGE" = "MGEs",
                           "MRG" = "MRGs",
                           "VFs" = "VFs",  # å¦‚æœ "VFs" å·²ç»æ˜¯éœ€è¦çš„å€¼, å¯ä»¥çœç•¥
                           "SGs" = "SGs"    # åŒç†ï¼Œ"SGs" ä¸å˜
  ))


unique(final_bio$GeneKind)
final_bio_stat <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_select_TY/FunctionalGeneFinalStat_unique.txt")



```

## ç»Ÿè®¡-ç—…åŸèŒç‰©ç§
```{r}
attach(HI_tax)
cat("Refseqä¸‹è½½åŸºå› ä¸­ç—…åŸèŒåŸºå› ç»„å æ¯”ï¼š", "%\n")
uniq_c(HI_tax$Type)

cat("Refseqä¸‹è½½åŸºå› ä¸­ç—…åŸèŒç‰©ç§å æ¯”ï¼š", "%\n")
temp <- HI_tax %>% select(taxid,speciesid,Type) %>% unique()
uniq_c(temp$Type)

HI_tax %>% select(taxid,speciesid,Type) %>% unique()


```


# HIæ³¨é‡Šæ•°æ®
```{r}
HI_ARGs <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_HighIndex/Final.AllARG.out.i90c90.i80c80.HMM")
HI_MGEs <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_HighIndex/Final.MGE.out.i90c90")
HI_MRGs <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_HighIndex/Final.MRG.out.i90c90")
HI_VFs <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_HighIndex/Final.VFs.out.i90c90")
HI_SGs <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_HighIndex/Final.STRESS.out.i90c90")

```

# HIé›·è¾¾å›¾åˆå¹¶åˆ†æ
```{r}
HI_ARGs_num <- uniq_c(HI_ARGs$ID)
HI_MGEs_num <- uniq_c(HI_MGEs$ID)
HI_MRGs_num <- uniq_c(HI_MRGs$ID)
HI_VFs_num <- uniq_c(HI_VFs$ID)
HI_SGs_num <- uniq_c(HI_SGs$ID)


# è¯»å…¥ç—…åŸèŒé¢„æµ‹æ•°æ®
DciPatho <- read.csv(file = "01.rawdata/DciPatho/07.geneme_DCiPatho_Prediction.csv")
DciPatho$GCFID <- stringr::str_extract(DciPatho$Filename, "^[^_]+_[^_]+") 
colnames(DciPatho) <- c("FileName","Pathogen","PredictResult","ID")
DciPatho <- DciPatho %>% select(ID,Pathogen)

  
GCFID <- read.delim(file = "01.rawdata/FunctionalGenem8/FunctionalGene_HighIndex/GCFID.Genome.list",header = F);colnames(GCFID) <- "ID"
HI_gene_num <- left_join(GCFID,HI_ARGs_num,by = join_by(ID)) %>% 
  left_join(.,HI_MGEs_num,by = join_by(ID)) %>% 
  left_join(.,HI_MRGs_num,by = join_by(ID)) %>% 
  left_join(.,HI_VFs_num, by = join_by(ID)) %>% 
  left_join(.,HI_SGs_num, by = join_by(ID))
colnames(HI_gene_num) <- c("ID","ARGs","MGEs","MRGs","VFs","SGs")
HI_gene_num[is.na(HI_gene_num) ] <- 0
head(HI_gene_num,10)


# ç‰©ç§æ°´å¹³å¹³å‡æ•°é‡
HI_gene_num <- left_join(HI_gene_num,HI_tax[,c(1:3)],by=c("ID"="assembly_accession"))
HI_gene_num_tax <- HI_gene_num
# åŸºå› ç»„æ°´å¹³å¹³å‡æ•°é‡
HI_species_num <- aggregate(HI_gene_num[2:5],by=list(HI_gene_num$taxid),FUN = "mean")
HI_gene_num <- HI_gene_num[,c(1:6)]



# åŸºå› ç»„æ ‡å‡†åŒ–å‡½æ•°
normalize <- function(x) {(x - min(x)) / (max(x) - min(x))}
# æå–éœ€è¦æ ‡å‡†åŒ–çš„åŠŸèƒ½åŸºå› åˆ—
gene_features <- HI_gene_num[, 2:6]
# ä½¿ç”¨min-maxæ ‡å‡†åŒ–
gene_scaled <- as.data.frame(lapply(gene_features, normalize))
# æ·»åŠ ç‰©ç§ID
gene_scaled$ID <- HI_gene_num$ID
# fmsbçš„é›·è¾¾å›¾æ ¼å¼è¦æ±‚æœ‰æœ€å¤§å€¼å’Œæœ€å°å€¼ä½œä¸ºç¬¬ä¸€è¡Œå’Œç¬¬äºŒè¡Œ
radar_data <- gene_scaled %>%
  select(-ID) %>%
  rbind(rep(1, ncol(.) ), rep(0, ncol(.)), .)
rownames(radar_data) <- c("max", "min", HI_gene_num$ID)

# è®¡ç®—é›·è¾¾å›¾é¢ç§¯ï¼ˆæ­£åˆ™å¤šè¾¹å½¢è¿‘ä¼¼ï¼‰
radar_area <- function(values) {
  theta <- 2 * pi / length(values)
  sum(values * lead(values, default = values[1]) * sin(theta) / 2)
}


```

## HIé›·è¾¾-è¡¥å……ç—…åŸèŒ
```{r}


HI_gene_num <- left_join(GCFID,HI_ARGs_num,by = join_by(ID)) %>% 
  left_join(.,HI_MGEs_num,by = join_by(ID)) %>% 
  left_join(.,HI_MRGs_num,by = join_by(ID)) %>% 
  left_join(.,HI_VFs_num, by = join_by(ID)) %>% 
  left_join(.,HI_SGs_num, by = join_by(ID)) %>% 
  left_join(.,DciPatho,by = join_by(ID))
colnames(HI_gene_num) <- c("ID","ARGs","MGEs","MRGs","VFs","SGs","Pathogens")
HI_gene_num[is.na(HI_gene_num) ] <- 0
head(HI_gene_num,10)



# ç‰©ç§æ°´å¹³å¹³å‡æ•°é‡
HI_gene_num <- left_join(HI_gene_num,HI_tax[,c(1:3)],by=c("ID"="assembly_accession"))
HI_gene_num_tax <- HI_gene_num
# åŸºå› ç»„æ°´å¹³å¹³å‡æ•°é‡
HI_species_num <- aggregate(HI_gene_num[2:5],by=list(HI_gene_num$taxid),FUN = "mean")
HI_gene_num <- HI_gene_num[,c(1:7)]



# åŸºå› ç»„æ ‡å‡†åŒ–å‡½æ•°
normalize <- function(x) {(x - min(x)) / (max(x) - min(x))}
# æå–éœ€è¦æ ‡å‡†åŒ–çš„åŠŸèƒ½åŸºå› åˆ—
gene_features <- HI_gene_num[, 2:7]
# ä½¿ç”¨min-maxæ ‡å‡†åŒ–
gene_scaled <- as.data.frame(lapply(gene_features, normalize))
# æ·»åŠ ç‰©ç§ID
gene_scaled$ID <- HI_gene_num$ID
# fmsbçš„é›·è¾¾å›¾æ ¼å¼è¦æ±‚æœ‰æœ€å¤§å€¼å’Œæœ€å°å€¼ä½œä¸ºç¬¬ä¸€è¡Œå’Œç¬¬äºŒè¡Œ
radar_data <- gene_scaled %>%
  select(-ID) %>%
  rbind(rep(1, ncol(.) ), rep(0, ncol(.)), .)
rownames(radar_data) <- c("max", "min", HI_gene_num$ID)

# è®¡ç®—é›·è¾¾å›¾é¢ç§¯ï¼ˆæ­£åˆ™å¤šè¾¹å½¢è¿‘ä¼¼ï¼‰
radar_area <- function(values) {
  theta <- 2 * pi / length(values)
  sum(values * lead(values, default = values[1]) * sin(theta) / 2)
}

rader_edge <- 6

```


## ç»Ÿè®¡-ä¸åŒåˆ†ç±»ä½“ç³»é›·è¾¾é¢ç§¯
```{r}
# è®¡ç®—é›·è¾¾å›¾é¢ç§¯ï¼ˆæ­£åˆ™å¤šè¾¹å½¢è¿‘ä¼¼ï¼‰
radar_area <- function(values) {
  theta <- 2 * pi / length(values)
  sum(values * lead(values, default = values[1]) * sin(theta) / 2)
}

# è®¡ç®—é›·è¾¾å›¾é¢ç§¯å æ¯”çš„å‡½æ•°
radar_area_percentage <- function(values, total_area) {
  # è®¡ç®—å•ä¸ªæ•°æ®ç‚¹çš„é›·è¾¾å›¾é¢ç§¯
  theta <- 2 * pi / length(values)
  area <- sum(values * lead(values, default = values[1]) * sin(theta) / 2)
  # è®¡ç®—è¯¥æ•°æ®ç‚¹å æ€»é¢ç§¯çš„æ¯”ä¾‹
  return(area / total_area)
}


# è®¡ç®—é›·è¾¾å›¾æ•´ä½“é¢ç§¯ï¼ˆå•ä½æ­£å¤šè¾¹å½¢çš„é¢ç§¯ï¼‰
radar_total_area <- function(n, r = 1) {
  # è®¡ç®—æ­£å¤šè¾¹å½¢çš„é¢ç§¯å…¬å¼
  return(0.5 * n * r^2 * sin(2 * pi / n))
}
total_area <- radar_total_area(6)


cat("é›·è¾¾å›¾é¢ç§¯åŠå æ¯”è®¡ç®—ï¼š", "%\n")
radar_data_area <- radar_data
radar_data_area$RadarArea <- apply(radar_data_area[,1:rader_edge], 1, radar_area)
radar_data_area$RadarAreaPercentage <- apply(radar_data_area[, 1:rader_edge], 1, radar_area_percentage, total_area = total_area)

```

## é›·è¾¾å¯è§†åŒ–æ•°æ®
```{r}
# åŸºå› ç»„æ•°æ®ç»Ÿè®¡åˆ†æ-------------
# å¯¹æ¯ä¸ªç‰©ç§è®¡ç®—é¢ç§¯
gene_scaled$RadarArea <- apply(gene_scaled[,1:rader_edge], 1, radar_area)
# æŸ¥çœ‹æ’å
gene_scaled %>%
  arrange(desc(RadarArea)) %>%
  select(ID, RadarArea)

# æ€»å’Œé£é™©å¾—åˆ†
# 1. è®¡ç®—æ¯ä¸ªåŸºå› ç»„çš„ç»¼åˆé£é™©å¾—åˆ†ï¼ˆæ€»å’Œï¼‰
gene_scaled$TotalRiskScore <- rowSums(gene_scaled[, 1:rader_edge])  # æˆ–è€…ä½ å…·ä½“çš„åˆ—åèŒƒå›´
# 2. æŒ‰ç…§æ€»å’Œæ‰“åˆ†è¿›è¡Œäº”åˆ†ä½åˆ’åˆ†
quantiles <- quantile(gene_scaled$TotalRiskScore, probs = seq(0, 1, 0.2))
# 3. ä½¿ç”¨ cut() å°†æ€»å’Œæ˜ å°„åˆ°äº”ä¸ªé£é™©ç­‰çº§
gene_scaled$RiskLevel <- cut(
  gene_scaled$TotalRiskScore,
  breaks = quantiles,
  labels = c("Very Low", "Low", "Medium", "High", "Very High"),
  include.lowest = TRUE
)

# æŸ¥çœ‹ç»“æœ
head(gene_scaled[, c("ID", "TotalRiskScore", "RiskLevel")])


  
# åˆå¹¶é›·è¾¾å›¾-------------
# åŸºå› ç»„æ°´å¹³åˆå¹¶åˆ†æ-------------
HI_gene_Plant <- HI_gene_num[which(HI_gene_num$ID %in% HI_tax_Plant$assembly_accession),]
HI_gene_Animal <- HI_gene_num[which(HI_gene_num$ID %in% HI_tax_Animal$assembly_accession),]
HI_gene_Zoonotic <- HI_gene_num[which(HI_gene_num$ID %in% HI_tax_Zoonotic$assembly_accession),]
HI_gene_ESKAPE <- HI_gene_num[which(HI_gene_num$ID %in% HI_tax_ESKAPE$assembly_accession),]
HI_gene_WHO <- HI_gene_num[which(HI_gene_num$ID %in% HI_tax_WHO$assembly_accession),]
HI_gene_Top10PlantPathogens<- HI_gene_num[which(HI_gene_num$ID %in% HI_tax_Top10PlantPathogens$assembly_accession),]
HI_gene_NonPathogens <- HI_gene_num[which(HI_gene_num$ID %in% HI_tax_NonPathogens$assembly_accession),]


head(HI_gene_Plant)
head(HI_gene_Animal)

# æ¯ç±»åˆ†åˆ«è®¡ç®—å‡å€¼
group_means <- function(df) {
  colMeans(df[, 2:c(rader_edge+1)])  # æå–åŠŸèƒ½åŸºå› çš„åˆ—
}

df_avg <- rbind(
  WHO = group_means(HI_gene_WHO),
  ESKAPE = group_means(HI_gene_ESKAPE),
  Zoonotic = group_means(HI_gene_Zoonotic),
  Animal = group_means(HI_gene_Animal),
  Top10PlantPathogens = group_means(HI_gene_Top10PlantPathogens),
  Plant = group_means(HI_gene_Plant),
  NonPathogens =group_means(HI_gene_NonPathogens)
)

# å¯¹æ¯åˆ—åš min-max æ ‡å‡†åŒ–
normalize <- function(x) (x - min(x)) / (max(x) - min(x))
df_scaled1 <- as.data.frame(apply(df_avg, 2, normalize))

normalize_1_5 <- function(x) 1 + 4 * (x - min(x)) / (max(x) - min(x))
df_scaled2 <- as.data.frame(apply(df_avg, 2, normalize_1_5))



# æ’å…¥æœ€å¤§å€¼ã€æœ€å°å€¼è¡Œç”¨äºé›·è¾¾å›¾ç»˜åˆ¶
radar_data1 <- rbind(rep(1, ncol(df_scaled1)), rep(0, ncol(df_scaled1)), df_scaled1)
radar_data2 <- rbind(rep(5, ncol(df_scaled2)), rep(1, ncol(df_scaled2)), df_scaled2)

radar_data1 <- radar_data1 %>% select(Pathogens,everything())
radar_data <- radar_data1
df_scaled <- df_scaled1
head(radar_data)
```

# HIé›·è¾¾å›¾å¯è§†åŒ–
```{r}
library(fmsb)
# å‡†å¤‡é›·è¾¾å›¾æ•°æ®
radar_data <- radar_data
radar_data <- radar_data %>% select(Pathogens,everything())


# å®šä¹‰é¢œè‰²æ–¹æ¡ˆ - åªåŒ…å«å®é™…å­˜åœ¨çš„ç±»åˆ«
pathogen_colors <- c(
  "Animal" = "#82B0D2",
  "Zoonotic" = "#F26B38", 
  "Plant" = "#8ECFC9",
  "NonPathogens"= "#e9e9e9",
  "WHO" = "#FFBE7A",
  "ESKAPE" = "#BEB8DC", 
  "Top10PlantPathogens" = "#2878b5"
)
# è·å–æ‰€æœ‰ç±»åˆ«åç§°ï¼ˆæ’é™¤Maxå’ŒMinï¼‰
categories <- rownames(radar_data)[3:9]

# ç¡®ä¿é¢œè‰²é¡ºåºä¸ç±»åˆ«é¡ºåºä¸€è‡´
colors_border <- pathogen_colors[categories]
colors_fill <- scales::alpha(colors_border, 0.4)

# è®¾ç½®PDFè¾“å‡º
pdf("03.figure/M_Radarchart.pdf", width = 7, height = 4)

# è®¾ç½®å›¾å½¢å¸ƒå±€
par(mfrow = c(2, 4), mar = c(1.1, 0.3, 1.1, 0.3), oma = c(0, 0, 2, 0))

# ç¬¬ä¸€ä¸ªå›¾å½¢ï¼šç»¼åˆé›·è¾¾å›¾
radarchart(radar_data,
  axistype = 1,
  pcol = colors_border,
  pfcol = colors_fill,
  plwd = 2,
  plty = 1,
  cglcol = "black", 
  cglty = 2, 
  cglwd = 0.8,
  axislabcol = "black",
  vlcex = 0.9,
  vlabels = colnames(radar_data),
 caxislabels = c("0", "", "50%", "", "100%"),  # åªæ˜¾ç¤ºå…³é”®åˆ»åº¦
  # caxislabels = c(0,1),
  title = "All Categories Overview"
)

# å¾ªç¯ç»˜åˆ¶å•ç‹¬é›·è¾¾å›¾
for (i in 1:length(categories)) {
  # åˆ›å»ºåªåŒ…å«å½“å‰ç±»åˆ«çš„æ•°æ®
  current_data <- rbind(rep(1, ncol(radar_data)), 
                        rep(0, ncol(radar_data)), 
                        radar_data[categories[i], , drop = FALSE])
  
  # ç»˜åˆ¶é›·è¾¾å›¾
  radarchart(current_data,
             axistype = 0,
             pcol = colors_border[i],
             pfcol = colors_fill[i],
             plwd = 2,
             plty = 1,
             cglcol = "black", 
             cglty = 2, 
             cglwd = 0.8,
             axislabcol = "black",
             vlcex = 0.7,
             # vlabels = colnames(df_scaled),
             vlabels = NA,  # ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºNAæ¥éšè—æ ‡ç­¾
             title = categories[i])
}

dev.off()

# åˆ›å»ºå•ç‹¬çš„å›¾ä¾‹æ–‡ä»¶
pdf("03.figure/M_RadarchartLegend.pdf", width = 5, height = 5)
plot.new()
legend("center",
       legend = categories,
       bty = "n",
       pch = 15,
       col = colors_border,
       text.col = "black",
       cex = 1.2,
       pt.cex = 2)
dev.off()

pdf("03.figure/M_RadarchartLegend2.pdf", width = 16, height = 2)
plot.new()
legend("center",
       legend = categories,
       bty = "n",
       pch = 15,
       col = colors_border,
       text.col = "black",
       cex = 1.2,
       pt.cex = 2,
       ncol = length(categories),  # è®¾ç½®åˆ—æ•°ç­‰äºç±»åˆ«æ•°é‡ï¼ˆæ¨ªå‘æ’åˆ—ï¼‰
       x.intersp = 0.5)  # è°ƒæ•´æ°´å¹³é—´è·
dev.off()


```


# HIé›·è¾¾å›¾å¯è§†åŒ–-gfä¿®æ”¹
```{r}
library(fmsb)

# å‡†å¤‡é›·è¾¾å›¾æ•°æ®ï¼ˆæ’é™¤NonPathogensï¼‰
categories_to_keep <- setdiff(rownames(radar_data)[3:9], "NonPathogens")
radar_data_filtered <- radar_data[1:8, ]

# å®šä¹‰é¢œè‰²æ–¹æ¡ˆ - æ’é™¤NonPathogens
pathogen_colors <- c(
  "Animal" = "#82B0D2",
  "Zoonotic" = "#F26B38", 
  "Plant" = "#8ECFC9",
  "WHO" = "#FFBE7A",
  "ESKAPE" = "#BEB8DC", 
  "Top10PlantPathogens" = "#2878b5"
)

# ç¡®ä¿é¢œè‰²é¡ºåºä¸ç±»åˆ«é¡ºåºä¸€è‡´
colors_border <- pathogen_colors[categories_to_keep]
colors_fill <- scales::alpha(colors_border, 0.4)

# è®¾ç½®PDFè¾“å‡º - åªåŒ…å«æ€»å›¾
pdf("03.figure/M_Radarchart_Overview.pdf", width = 6, height = 6)
par(mar = c(2, 2, 3, 2))

# ç¬¬ä¸€ä¸ªå›¾å½¢ï¼šç»¼åˆé›·è¾¾å›¾ï¼ˆä¸å«NonPathogensï¼‰
head(radar_data_filtered)
radarchart(radar_data_filtered,
  axistype = 1,
  pcol = colors_border,
  pfcol = colors_fill,
  plwd = 2,
  plty = 1,
  cglcol = "black", 
  cglty = 2, 
  cglwd = 0.8,
  axislabcol = "black",
  vlcex = 0.9,
  vlabels = colnames(radar_data_filtered),
  caxislabels = c("0", "25%", "50%", "75%", "100%"),
  title = "Pathogen Categories Overview"
)

dev.off()

# è®¾ç½®PDFè¾“å‡º - åˆ†å›¾
pdf("03.figure/M_Radarchart_Individual.pdf", width = 8, height = 5)

# è®¾ç½®å›¾å½¢å¸ƒå±€ - 2è¡Œ3åˆ—ï¼ˆå› ä¸ºç°åœ¨æœ‰6ä¸ªç±»åˆ«ï¼‰
par(mfrow = c(2, 3), mar = c(0.5, 0.1, 1.5, 0.1), oma = c(0.5, 0.5, 0.5, 0.5))

# å¾ªç¯ç»˜åˆ¶å•ç‹¬é›·è¾¾å›¾ï¼ˆæ’é™¤NonPathogensï¼‰
for (i in 1:length(categories_to_keep)) {
  # åˆ›å»ºåªåŒ…å«å½“å‰ç±»åˆ«çš„æ•°æ®
  current_data <- rbind(rep(1, ncol(radar_data)), 
                        rep(0, ncol(radar_data)), 
                        radar_data[categories_to_keep[i], , drop = FALSE])
  
  # ç»˜åˆ¶é›·è¾¾å›¾
  radarchart(current_data,
             axistype = 0,
             pcol = colors_border[i],
             pfcol = colors_fill[i],
             plwd = 2,
             plty = 1,
             cglcol = "black", 
             cglty = 2, 
             cglwd = 0.8,
             axislabcol = "black",
             vlcex = 0,
             vlabels = NA,
             title = categories_to_keep[i])
}

dev.off()

```



# å®¿ä¸»å±å®³è¯„ä»·ç­‰çº§ä¸åŠŸèƒ½åŸºå› é£é™©å¾—åˆ†
```{r}
attach(NewPA_Air)
attach(gene_scaled)
attach(HI_gene_num_tax)


temp <- NewPA_Air %>% select(species_taxid,Type,PathogenRiskScore)
temp$species_taxid <- as.numeric(temp$species_taxid) # è½¬ä¸ºæ•°å€¼å‹
HI_gene_num_tax$taxid <-  as.numeric(HI_gene_num_tax$taxid )


temp2 <- left_join(HI_gene_num_tax,temp,by=c("speciesid"="species_taxid"))
temp2$Type[is.na(temp2$Type)] <- "NonPathogens"
temp2$PathogenRiskScore[is.na(temp2$PathogenRiskScore)] <- 0

colnames(temp2)
df1 <- temp2 %>% select(ID,ARGs,MGEs,MRGs,VFs,SGs,PathogenRiskScore,taxid,Type)

normalize <- function(x) (x - min(x)) / (max(x) - min(x))
df1$ARGs_scaled <- normalize(df1$ARGs)
df1$MGEs_scaled <- normalize(df1$MGEs)
df1$MRGs_scaled <- normalize(df1$MRGs)
df1$VFs_scaled  <- normalize(df1$VFs)
df1$SGs_scaled  <- normalize(df1$SGs)
df1$PathogenRisk_scaled <- normalize(df1$PathogenRiskScore)


df1$GeneRiskScore <- rowSums(df1[,c("ARGs_scaled", "MGEs_scaled", "MRGs_scaled", "VFs_scaled", "SGs_scaled")])
df1$GeneRiskScore <- rowSums(df1[,c("ARGs_scaled", "MGEs_scaled", "MRGs_scaled", "VFs_scaled", "SGs_scaled")])


df1$RadarArea <- apply(df1[,10:14], 1, radar_area)


# æœ€ç»ˆé£é™©æŒ‡æ•°ï¼ˆIntegratedRiskScoreï¼‰
alpha <- 0.6  # åŠŸèƒ½åŸºå› å æ¯”
beta <- 0.4   # å®¿ä¸»é£é™©å æ¯”
df1$IntegratedRiskScore <- alpha * df1$GeneRiskScore + beta * df1$PathogenRisk_scaled

breaks <- quantile(df1$IntegratedRiskScore, probs = seq(0, 1, length.out = 6))
df1$RiskLevel <- cut(df1$IntegratedRiskScore, breaks = breaks, labels = 1:5, include.lowest = TRUE)
Risk_cor <- df1

P_risk_cor <- ggplot(Risk_cor,aes(x=PathogenRiskScore,y = GeneRiskScore))+
  geom_point(alpha=.2,color="#F5C045",size = 1.5)+
  geom_smooth(method = lm,show.legend = F)+
  stat_cor( method = "spearman",show.legend = F)+
  theme_jgf()+
  theme_jgfbw()
P_risk_cor


P_risk_cor <- ggplot(Risk_cor, aes(x = PathogenRiskScore, y = RadarArea)) +
  geom_point(alpha = 0.2, color = "#F5C045", size = 1.5) +
  geom_smooth(method = lm, show.legend = F,color="black") +
  stat_cor(method = "spearman", show.legend = F) +
  theme_jgf() +
  theme_jgfbw() +
  theme(
    panel.border = element_blank(),  # ç§»é™¤é¢æ¿è¾¹æ¡†
    axis.line = element_blank()      # ç§»é™¤åæ ‡è½´çº¿
  )
P_risk_cor



bptracer::color_scheme_bp(color_zyz6[1:4])
colorNew <- color_zyz6[1:4]
names(colorNew) <- c("NonPathogens","Plant","Zoonotic","Animal")


# è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
cor_test <- cor.test(Risk_cor$PathogenRiskScore, Risk_cor$GeneRiskScore, method = "spearman")
lm_fit <- lm(GeneRiskScore ~ PathogenRiskScore, data = Risk_cor)
r_squared <- summary(lm_fit)$r.squared
p_value <- cor_test$p.value


P_risk_cor <- ggplot(Risk_cor, aes(x = PathogenRiskScore, y = log(RadarArea+0.0001))) +
  
  # è°ƒæ•´geom_jitterå‚æ•°
  geom_jitter(
    aes(color = Type),
    alpha = 0.3,           # å¢åŠ é€æ˜åº¦ï¼Œè®©é‡å ç‚¹å¯è§
    size = 0.1,            # ç¨å¾®å‡å°ç‚¹çš„å¤§å°
    width = 0.2,           # æ§åˆ¶xæ–¹å‘çš„æŠ–åŠ¨èŒƒå›´
    height = 0.1,          # æ§åˆ¶yæ–¹å‘çš„æŠ–åŠ¨èŒƒå›´
    shape = 16             # ä½¿ç”¨å®å¿ƒåœ†ç‚¹
  ) +
  scale_x_continuous(
    breaks = function(x) seq(floor(min(x)), ceiling(max(x)), by = 1),
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  geom_smooth(method = lm, show.legend = F, color = "black") +
  # stat_cor() +
  stat_cor( method = "spearman",show.legend = F)+
  theme_jgfbw() +
  theme(legend.position = "none") +
  scale_color_manual(values = colorNew) +
  xlab("Pathogen Risk Score") +
  ylab("log10(Radar Area of Genomes)")
P_risk_cor
ggsave(filename = "03.figure/M_RadarchartCor.pdf",height = 4,width = 3.5)
```

## å…¶ä»–æµ‹è¯•
```{r}
P_risk_cor <- ggplot(Risk_cor, aes(x = PathogenRiskScore, y = log(RadarArea+0.0001))) +
# P_risk_cor <- ggplot(Risk_cor[which(!Risk_cor$Type=="NonPathogens"),], aes(x = PathogenRiskScore, y = log(RadarArea))) +

  # geom_point(alpha = 0.2, color = "#F5C045", size = 1.5) +
  geom_jitter(alpha = 0.02, aes(color=Type), size = 1.5) +
  geom_smooth(method = lm, show.legend = F, color = "black") +
  
  # æ‰‹åŠ¨æ·»åŠ ç»Ÿè®¡ä¿¡æ¯æ ‡æ³¨
  # annotate("text", x = -Inf, y = Inf, 
  #          label = paste0("Spearman Ï = ", round(cor_test$estimate, 3), 
  #                        "\n  p = ", format.pval(p_value, digits = 3),
  #                        "\n  RÂ² = ", round(r_squared, 3),
  #                        "\n  n = ", nrow(Risk_cor)),
  #          hjust = -0.1, vjust = 2, size = 4) +
  
  theme_jgfbw() +
  # theme(
  #   panel.border = element_blank(),  # ç§»é™¤é¢æ¿è¾¹æ¡†
  #   axis.line = element_blank()      # ç§»é™¤åæ ‡è½´çº¿
  # )+
  theme(legend.position = "bottom")+
  scale_color_manual(values = colorNew )+
  xlab("Pathogen Risk Score")+ylab("log10[Radar Area of Genomes]")
P_risk_cor


P_risk_cor <- ggplot(Risk_cor[which(!Risk_cor$Type=="NonPathogens"),], aes(x = PathogenRiskScore, y = log(RadarArea+0.00001))) +
  # å¯†åº¦å¡«å……å›¾ï¼ˆæ ¹æ®å¯†åº¦åˆ†å¸ƒæ·»åŠ é€æ˜æ•ˆæœï¼‰
  stat_density_2d(
    aes(fill = ..density.., alpha = ..density..), 
    geom = 'tile', 
    contour = FALSE, 
    n = 100
  ) +
  # å¯†åº¦ç­‰é«˜çº¿
  geom_density_2d(aes(color = ..level..), linewidth = 0.5) +  # å¢åŠ çº¿å®½
  # æ·»åŠ çº¿æ€§å›å½’çº¿
  geom_smooth(method = lm, show.legend = F, color = "black", se = TRUE) +
  stat_cor() +
  # é¢œè‰²å’Œå¡«å……çš„æ¸å˜è®¾ç½® - è°ƒæ•´é¢œè‰²èŒƒå›´ä½¿ä½å¯†åº¦åŒºåŸŸæ›´æ˜æ˜¾
  scale_fill_gradientn(
    colors = c('#F0F0F0', '#555AA6', '#74C5A2', '#FCF8B5', '#F57948', '#AA1246'),
    values = scales::rescale(c(0, 0.1, 0.3, 0.5, 0.7, 1))  # è°ƒæ•´é¢œè‰²åˆ†å¸ƒ
  ) +
  scale_color_gradientn(
    colors = c('#CCCCCC', '#555AA6', '#74C5A2', '#FCF8B5', '#F57948', '#AA1246'),
    values = scales::rescale(c(0, 0.1, 0.3, 0.5, 0.7, 1))  # è°ƒæ•´é¢œè‰²åˆ†å¸ƒ
  ) +
  scale_alpha_continuous(range = c(0.3, 0.9), guide = "none") +  # æé«˜é€æ˜åº¦èŒƒ
  # è®¾ç½®xè½´ä¸ºæ•´æ•°åˆ»åº¦
  scale_x_continuous(
    breaks = function(x) {
      seq(floor(min(x)), ceiling(max(x)), by = 1)  # ç”Ÿæˆæ•´æ•°åˆ»åº¦
    },
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  # ä¸»é¢˜è®¾ç½®
  theme_jgfbw() +
  theme(legend.position = "none") +  # éšè—æ‰€æœ‰å›¾ä¾‹
  # åæ ‡è½´æ ‡ç­¾
  xlab("Pathogen Risk Score") +
  ylab("log10[Radar Area of Genomes]")
P_risk_cor

P_risk_cor <- ggplot(Risk_cor, aes(x = PathogenRiskScore, y = log(RadarArea+0.0001))) +
  geom_point(size = 1, alpha = 0.3, color = "#555AA6") +
  geom_density_2d(aes(color = ..level..)) +
  geom_smooth(method = lm, show.legend = F, color = "black", se = TRUE) +
  scale_color_gradientn(colors = c('#555AA6', '#74C5A2', '#FCF8B5', '#F57948', '#AA1246')) +
  theme_jgfbw() +
  theme(legend.position = "none") +
  xlab("Pathogen Risk Score") +
  ylab("log10[Radar Area of Genomes]")
P_risk_cor


library(gghalves)
Risk_cor$Type 
Risk_cor$Type <- factor(Risk_cor$Type,levels = c("NonPathogens","Plant","Animal","Zoonotic"))
P_violin <-ggplot(Risk_cor,aes(x=Type,y=RadarArea))+
  geom_half_violin(aes(fill=Type,color=Type),position=position_nudge(x=0.1,y=0),side='R',adjust=1.2,trim=F,color=NA,alpha=1)+
  geom_jitter(aes(fill=Type,color=Type),size=.2,width = 0,show.legend = F)+
  geom_boxplot(aes(fill=Type,color=Type),outlier.shape = NA,width =0.2,alpha=0.8,show.legend = F)+
  theme_jgfbw()+
  scale_fill_manual(values = colorNew)+
  scale_color_manual(values = colorNew)
P_violin

```

# ä¸»å›¾-åŠŸèƒ½åŸºå› æ¡‘å‰å›¾
```{r}
attach(final_bio)
# æ•°æ®åº“é£é™©åŸºå› æŒ‡æ•°è¡¨
# æ•°æ®åº“åŠŸèƒ½åŸºå› ç»„æˆ
# æ•°æ®åº“æº¯æºè¡¨

final_bio_risk <- left_join(final_bio,Risk_cor[,c(1,c(7,9,17:18))],by=c("GCFID"="ID"))
head(final_bio)
temp <- final_bio_risk %>% select(GCFID,Type) %>% unique() %>% select(GCFID) %>% uniq_c()
head(temp)


temp <- final_bio_risk %>% select(GeneKind,Phylum,Type,PathogenRiskScore)
library(bptracer)
temp2 <- profile_top_col(inputtable = temp,n = 5,measure.vars = "Phylum",replaceName = "Others")
colnames(temp2)
sankey1 <- plot_sankey_analyisis(inputtable = temp2,measure.vars = c("GeneKind","Phylum","Type","PathogenRiskScore"),visualization = T)
plot_sankey_visualization(prefix = "AllGene",Links = sankey1$sankey_linklist,sankey1$sankey_nodelist,color = color_scheme_bp("color_zyz6")[5:8],path = "03.figure/Sankey/",height = 350,width = 500)



```

# æ•°æ®å¯è§†åŒ–
```{r}

attach(final_bio)
head(final_bio)
df1 <- profile_top_col(inputtable = final_bio,n = 30,measure.vars = "Species")
df2 <- df1 %>% select(GeneKind,Kindom,Phylum,Class,Order,Family,Genus,Species) %>% uniq_c_df()
ggplot(df2,aes(x = GeneKind,y =Count,fill=Species))+
  geom_col()+
  facet_wrap(~GeneKind,scales = "free")+
  xlab("Gene host compostion (top 20 species)")
ggplot(df2,aes(x = GeneKind,y =Count,fill=Phylum))+
  geom_col()+
  facet_wrap(~GeneKind,scales = "free")



```

# æœ€ç»ˆæ•°æ®åº“å¯è§†åŒ–
```{r}
attach(final_bio)
df1 <- final_bio %>% dplyr::select(GeneKind,Phylum) %>% uniq_c_df()
df2 <- final_bio %>% dplyr::select(GeneKind,GeneType) %>% uniq_c_df()
df3 <- final_bio %>% dplyr::select(GeneKind,GeneABB) %>% uniq_c_df()

p1 <- ggplot(data = df1,aes(x=GeneKind,y=Count,fill=Phylum))+
 geom_bar(stat = "identity",position="fill", width=1)+
  theme_jgfbw()+
  xlab("Gene Kind")+ylab("Percentage")+
  scale_y_continuous(labels = scales::percent,expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) 

p1

p1 <- ggplot(data = df2,aes(x=GeneKind,y=Count,fill=GeneType))+
 geom_bar(stat = "identity",position="fill", width=1)+
  theme_jgfbw()+
  xlab("Gene Kind")+ylab("Percentage")+
  scale_y_continuous(labels = scales::percent,expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) 


p2 <- ggplot(data = df1,aes(x=GeneKind,y=Count))+
 geom_bar(stat = "identity", width=1)+
  theme_jgf3()+
  xlab("")+ylab("Count")+
  scale_y_continuous(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) 

  
p2/p1
```




# æ•°æ®ä¿å­˜
```{r}
save(final_bio_risk,final_bio,file = "02.datasave/02.HiIndex.Rdata")
load(file = "02.datasave/02.HiIndex.Rdata")
```


# æ•°æ®åº“æ•°æ®åº“GeneNumberç»„æˆå±•ç¤º
```{r}
# åŠŸèƒ½åŸºå› æ€»ä½“ç»Ÿè®¡è¡¨ï¼
uniq_c(final_bio_risk$GeneKind) %>% print()
state_gene <- final_bio_risk %>% select(GeneKind,Type) %>% uniq_c_df(.,count = T)

# Rose plot---------------------------------
# state_gene$Kind <- factor(state_gene$Kind,levels = c("Pathogen","Nonpathogen"))
ggplot(data = state_gene,aes(x = GeneKind,y = Count,fill=Type) )+
  geom_col(width = .8)+
  # scale_fill_manual(values = c("#E0144C","#54B435"))+
  theme(legend.position = "top")+
  xlab("")+ylab("Number of genes")+
  coord_polar(theta = "y",start = 0)+
  theme_void() +
  ylim(c(-120000,120000))+
  # theme_nothing()+
  # theme(axis.ticks.x = element_blank(),axis.text.x = element_blank())+
  theme(legend.background = element_rect(fill='transparent'),legend.title = element_blank())
ggsave(filename = "03.figure/state_pathonge_rose.pdf",height = 3,width = 3)
```


# æ•°æ®åº“Phylumç»„æˆç»Ÿè®¡
ä¸åŒé—¨æ°´å¹³çš„é‰´å®šçš„åŸºå› æ•°é‡
ä¸åŒé—¨æ°´å¹³çš„é‰´å®šçš„ç‰©ç§å®¿ä¸»æ•°é‡

```{r}
# è®¡ç®—æ‰€æœ‰Phylumä¸Šçš„Geneä¸ªæ•°
state_phylum_gene <- final_bio_risk %>% select(Phylum,GeneKind,Type) %>% uniq_c_df(.,count = T)
state_phylum_gene$Type2 <- "Numbers of genes"
# å®šä¹‰é¡ºåºé¢
state_phylum_order <- uniq_c(final_bio$Phylum,desc = F)
# é€‰å–TopN
TopName <-state_phylum_order %>% .[,1] %>% .[1:6] %>% as.character()
state_phylum_gene_top <- state_phylum_gene
state_phylum_gene_top$Phylum[!state_phylum_gene_top$Phylum %in%  TopName] <- "Other Phylum"
state_phylum_gene_top$Phylum <- factor(state_phylum_gene_top$Phylum,levels = c(TopName,"Other Phylum"))


bptracer::color_scheme_bp(color_zyz6[1:4])
colorNew <- color_zyz6[1:4]
names(colorNew) <- c("NonPathogens","Plant","Zoonotic","Animal")
uniq_c(state_phylum_gene_top$Type)
state_phylum_gene_top$Type <- factor(state_phylum_gene_top$Type,levels = c("NonPathogens","Plant","Animal","Zoonotic"))

biopollutome_Phylum_gene <- ggplot(data = state_phylum_gene_top, aes(x = Phylum, y = Count)) +
  geom_col(aes(fill = Type)) +  # Use 'Type' as the fill
  facet_wrap(~GeneKind, scales = "free_x", nrow = 1) +
  scale_y_continuous(
    labels = function(x) {
      ifelse(x == 0, "0", scales::scientific_format()(x))
    },
    breaks = function(x) pretty(x, n = 3)
  ) +
  coord_flip() +
  theme_jgfbw() +
  scale_fill_manual(values =colorNew) +  # Use color mapping for 'Type'
  theme(
    # axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5),
    # legend.position = c(0.88, 0.7),
    legend.position = "none",
    legend.background = element_rect(fill = 'transparent'),
    legend.title = element_blank(),
    legend.key.size = unit(0.5, 'lines')
  ) +
  ylab("Number of genes identified in different phyla")

biopollutome_Phylum_gene

# è®¡ç®—æ‰€æœ‰Phylumä¸Šçš„ç‰©ç§ä¸ªæ•°
attach(final_bio)
state_phylum_species <- final_bio_risk %>% select(Phylum,Species,GeneKind,Type) %>% unique()
state_phylum_species <- state_phylum_species %>% select(Phylum,GeneKind,Type) %>% uniq_c_df(.,count = T)
state_phylum_species$Type2 <- "Numbers of Species"
# Topåˆå¹¶
TopName <-state_phylum_order %>% .[,1] %>% .[1:6] %>% as.character()
state_phylum_species_top <- state_phylum_species
state_phylum_species_top$Phylum[!state_phylum_species$Phylum %in%  TopName] <- "Other Phylum"
state_phylum_species_top$Phylum <- factor(state_phylum_species_top$Phylum,levels = c(TopName,"Other Phylum"))

state_phylum_species_top$Type <- factor(state_phylum_species_top$Type,levels = c("NonPathogens","Plant","Animal","Zoonotic"))

biopollutome_Phylum_Species <- ggplot(data = state_phylum_species_top,aes(x = Phylum,y = Count) )+
  geom_col(aes(fill=Type))+
  facet_wrap(~GeneKind,scales = "free_x",nrow =1 )+
  scale_y_continuous(
    labels = function(x) {
      ifelse(x == 0, "0", scales::scientific_format()(x))
    },
    breaks = function(x) pretty(x, n = 3)
  ) +
  coord_flip()+
  theme_jgfbw()+
  # scale_fill_simpsons()+
  scale_fill_manual(values =colorNew) +  # Use color mapping for 'Type'
  # theme(axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5),
  #       legend.position = c(.88,.1))+
  theme(legend.position = c(.93,.8),
            legend.key.size = unit(0.5, 'lines'))+
  theme(legend.background = element_rect(fill='transparent'),legend.title = element_blank())+
  ylab("Number of species hosts identified in different phyla")
biopollutome_Phylum_Species

# æ‹¼å›¾
biopollutome_final <- biopollutome_Phylum_Species/biopollutome_Phylum_gene
ggsave(filename = "03.figure/M_biopollutomeStatCol.pdf",height = 5.2,width = 10)

# ä¸»å›¾åˆå¹¶
design1 <- c("11111
              22222
              33444")

biopollutome_Phylum_gene+biopollutome_Phylum_Species+P_risk_cor+
    plot_layout(design = design1)


```
## ç»Ÿè®¡-Top4é—¨æ°´å¹³åŠç—…åŸèŒçš„åŸºå› å æ¯”
```{r}
attach(final_bio_risk)
cat("Top4çš„ç‰©ç§é—¨ç±»ï¼š", "%\n")
uniq_c(final_bio_risk$Phylum) %>% head(4)
temp1 <- final_bio_risk %>% select(GeneKind,Type) 
temp1$Type2 <- temp1$Type
temp1$Type2[which(temp1$Type2!="NonPathogens")] <- "Pathogens"
temp1 <- temp1 %>% select(GeneKind,Type2) %>% uniq_c_df()

head(temp1)

# è®¡ç®—æ¯ä¸ª GeneKind ä¸­ç—…åŸèŒæºå¸¦åŸºå› çš„å æ¯”
gene_kind_percentage <- temp1 %>%
  group_by(GeneKind) %>%
  mutate(
    # è®¡ç®—å½“å‰ GeneKind çš„æ€»åŸºå› æ•°
    total_genes = sum(Count),
    # è®¡ç®— Pathogens çš„åŸºå› æ•°
    pathogens_genes = sum(Count[Type2 == "Pathogens"])
  ) %>%
  # è®¡ç®—ç—…åŸèŒæºå¸¦åŸºå› å æ¯”
  mutate(
    pathogens_percentage = round(pathogens_genes / total_genes * 100, 2)
  ) %>%
  # ä¿ç•™æ¯ä¸ª GeneKind åªæ˜¾ç¤ºä¸€æ¬¡ç»“æœ
  distinct(GeneKind, .keep_all = TRUE)

# æŸ¥çœ‹ç»“æœ
cat("ç—…åŸèŒç‰©ç§å 5ç§åŠŸèƒ½åŸºå› ä¸­çš„æ¯”ä¾‹ï¼š", "%\n")
print(gene_kind_percentage[, c("GeneKind", "pathogens_percentage")])


```

## ç»Ÿè®¡-ç—…åŸèŒç‰©ç§å’ŒåŸºå› å æ¯”
```{r}


attach(HI_tax)
HI_tax$Type2 <- HI_tax$Type
HI_tax$Type2[which(HI_tax$Type2!="NonPathogens")] <- "Pathogens"
uniq_c(HI_tax$Type2)
HI_tax_species <- HI_tax %>% select(speciesid,Type2) %>% unique()
HI_tax_PA <- uniq_c(HI_tax_species$Type2)

cat("ç—…åŸèŒç‰©ç§å æ¯”è®¡ç®—ï¼š", "%\n")
HI_tax_PA[which(HI_tax_PA$ID=="Pathogens"),2]/sum(HI_tax_PA$Count) %>% print()


attach(final_bio_risk)
cat("ç—…åŸèŒåŸºå› ç»„å æ¯”è®¡ç®—ï¼š", "%\n")
uniq_c(final_bio_risk$GeneKind)
temp1 <- final_bio_risk
temp1$Type2 <- temp1$Type
temp1$Type2[which(temp1$Type2!="NonPathogens")] <- "Pathogens"

HI_tax_PA_Gene <- uniq_c(temp1$Type2)
cat("ç—…åŸèŒåŸºå› ç»„å æ¯”è®¡ç®—ï¼š", "%\n")
HI_tax_PA_Gene[which(HI_tax_PA_Gene$ID=="Pathogens"),2]/sum(HI_tax_PA_Gene$Count) %>% print()


```


# æ•°æ®åº“T-testæ£€éªŒ
```{r}

attach(final_bio_risk)
head(final_bio_risk)

temp1 <- final_bio_risk %>% select(GCFID,GeneKind,Type) %>% uniq_c_df()
attach(refseq_240519_usedInfoRaw)
temp2 <- refseq_240519_usedInfoRaw %>% select(assembly_accession,genome_size)
temp3 <- left_join(temp1,temp2,by=c("GCFID"="assembly_accession"))
temp3$genome_size <- as.numeric(temp3$genome_size)
temp3$Freq <- temp3$Count/temp3$genome_size
bac_bp_freq <- temp3
# åŸºäºgenome_sizeå¯¹æ¯ä¸ªåŸºå› ç»„è¿›è¡Œæ¯”æ ‡å‡†è¯

# è®¾ç½® Type é¡ºåº
bac_bp_freq$Type2 <- bac_bp_freq$Type 
bac_bp_freq$Type2[which(bac_bp_freq$Type2!="NonPathogens")] <- "Pathogens"

bac_bp_freq$Type2 <- factor(bac_bp_freq$Type2,levels = c("NonPathogens", "Pathogens"))
bac_bp_freq$Type <- factor(bac_bp_freq$Type,levels = c("NonPathogens", "Plant", "Animal", "Zoonotic"))


# å»æ‰æ¯ä¸ªGeneKindä¸­Freqå¤§äº99%åˆ†ä½æ•°çš„å€¼
bac_bp_freq <- bac_bp_freq %>%
  group_by(GeneKind) %>%
  mutate(q99 = quantile(Freq, 0.99)) %>%
  filter(Freq <= q99) %>%
  ungroup()

# å¯é€‰é…è‰²æ–¹æ¡ˆ
type_colors <- c("NonPathogens" = "#66c2a5", 
                 "Plant" = "#fc8d62", 
                 "Animal" = "#8da0cb", 
                 "Zoonotic" = "#e78ac3")

# ä½œå›¾
p <- ggplot(data = bac_bp_freq, aes(x = Type, y = Freq, fill = Type)) +
  facet_wrap(~GeneKind, scales = "free_y", nrow = 1) +
  geom_boxplot(outlier.size = 0.7, outlier.alpha = 0.2,size=.2) +  # è°ƒæ•´ç¦»ç¾¤ç‚¹å¯è§†åŒ–
  stat_summary(fun = mean, geom = "point", shape = 18, size = 2.5, color = "black") +  # æ·»åŠ å‡å€¼

  stat_compare_means(comparisons = list(
                        c("NonPathogens", "Plant"),
                        c("NonPathogens", "Animal"),
                        c("NonPathogens", "Zoonotic"),
                        c("Plant", "Animal"),
                        c("Plant", "Zoonotic"),
                        c("Animal", "Zoonotic")
                      ),
                      method = "t.test", label = "p.signif", hide.ns = TRUE,
                      size = 3, vjust = 0.5) +
  scale_fill_manual(values = color_zyz6) +
  theme_jgfbw() +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 30, hjust = 1)
  ) +
  xlab("") +
  ylab("Normalized gene count (per bp of genome)")
p
ggsave(filename = "03.figure/S_biopollutome_compare.pdf",height = 4,width = 9)

bac_bp_freq$Type2

p <- ggplot(data = bac_bp_freq, aes(x = Type2, y = Freq, fill = Type2)) +
  facet_wrap(~GeneKind, scales = "free_y", nrow = 1) +
  geom_boxplot(outlier.size = 0.7, outlier.alpha = 0.2,size=.2) +  # è°ƒæ•´ç¦»ç¾¤ç‚¹å¯è§†åŒ–
  stat_summary(fun = mean, geom = "point", shape = 18, size = 2.5, color = "black") +  # æ·»åŠ å‡å€¼

  stat_compare_means(comparisons = list(c("NonPathogens", "Pathogens")),
                     method = "wilcox.test", label = "p.signif", 
                     size = 3, vjust = 0.5) +
  scale_fill_manual(values = color_zyz6) +
  theme_jgfbw() +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 30, hjust = 1)
  ) +
  xlab("") +
  ylab("Normalized gene count (per bp of genome)")
p
# ggsave(filename = "03.figure/S_biopollutome_compare.pdf",height = 4,width = 9)


# æ ‡å‡†åŒ–å¯è§†åŒ–
# my_comparison=c("Nonpathogen","Pathogen")
ggplot(data = bac_bp_freq,aes(x =Type,y = Freq))+
  facet_wrap(~GeneKind,scales = "free_y",nrow = 1)+
  geom_boxplot()+
  # geom_jitter(alpha=.1,size=1,aes(color=Type))+
  # scale_color_manual(values = rev(color_zyz2))+
  theme_jgfbw()+
  stat_compare_means(method = "t.test", method.args = list(var.equal = FALSE),
                     label = "p.signif",
                     vjust=2,
                     hjust=-1,
                     hide.ns = TRUE) +
  theme(legend.position = "none")+
  xlab("")+
  # xlab("Number of functional genes carried on each Pangenome")+
  ylab("Gene per genome")
ggsave(filename = "03.fig/S4/biopollutome_compare.pdf",height = 2.5,width = 9)







```


# æ•°æ®åº“T-testæ£€éªŒ
```{r}

# å®šä¹‰é¢œè‰²æ–¹æ¡ˆ - åªåŒ…å«å®é™…å­˜åœ¨çš„ç±»åˆ«
pathogen_colors2 <- c(
  "Pathogens" = "#bf0043",
  "NonPathogens"= "#e9e9e9"
)
pathogen_color3 <- c(
  "Animal" = "#82B0D2",
  "Zoonotic" = "#F26B38", 
  "Plant" = "#8ECFC9",
  "NonPathogens"= "#e9e9e9"
)

attach(final_bio_risk)
attach(HI_tax)

tTest_gene <- final_bio_risk 
tTest_gene <- tTest_gene %>% select(ID,GeneKind) %>% uniq_c_df()

# æ·»åŠ ä¸€ä¸ªåˆå¹¶çš„é€‰é¡¹ tTest_gene_all
all_gene_sum <- tTest_gene %>%
  group_by(ID) %>%
  summarise(Count = sum(Count, na.rm = TRUE)) %>%
  mutate(GeneKind = "All Gene Kinds") %>% select(ID,GeneKind,Count)
tTest_gene_all <- rbind(tTest_gene,all_gene_sum)


attach(Pangenome_stat_final)
Pangenome_stat_final$species_taxid <- as.numeric(Pangenome_stat_final$species_taxid )
temp1 <- HI_tax %>% select(speciesid,Type,Type2) %>% unique()
temp1$speciesid <- as.numeric(temp1$speciesid )


# å®šä¹‰äº”ç±» GeneKind
all_kinds <- c("ARGs", "VFs", "MRGs", "MGEs", "SGs")
# å·¦è¿æ¥åè¡¥é½æ‰€æœ‰ GeneKindï¼Œå¹¶å°†ç¼ºå¤± Count å¡« 0
temp2 <- left_join(temp1, tTest_gene, by = c("speciesid" = "ID")) %>%
  complete(speciesid, GeneKind = all_kinds, fill = list(Count = 0)) %>%
  filter(!is.na(GeneKind))   # æŠŠ GeneKind ä¸º NA çš„é‚£æ¡åŸå§‹è¡Œä¸¢æ‰

temp3 <- left_join(temp1,temp2[, c("speciesid", "GeneKind", "Count")],by = "speciesid")
tTest_gene_final <- left_join(temp3,Pangenome_stat_final,by = c("speciesid" = "species_taxid"))
tTest_gene_final$Freq <- tTest_gene_final$Count / tTest_gene_final$`GeneLength cdhit`


# å®šä¹‰äº”ç±» GeneKind
all_kinds <- c("ARGs", "VFs", "MRGs", "MGEs", "SGs","All Gene Kinds")
# å·¦è¿æ¥åè¡¥é½æ‰€æœ‰ GeneKindï¼Œå¹¶å°†ç¼ºå¤± Count å¡« 0
temp2 <- left_join(temp1, tTest_gene_all, by = c("speciesid" = "ID")) %>%
  complete(speciesid, GeneKind = all_kinds, fill = list(Count = 0)) %>%
  filter(!is.na(GeneKind))   # æŠŠ GeneKind ä¸º NA çš„é‚£æ¡åŸå§‹è¡Œä¸¢æ‰

temp3 <- left_join(temp1,temp2[, c("speciesid", "GeneKind", "Count")],by = "speciesid")
tTest_gene_final2 <- left_join(temp3,Pangenome_stat_final,by = c("speciesid" = "species_taxid"))
tTest_gene_final2$Freq <- tTest_gene_final2$Count / tTest_gene_final2$`GeneLength cdhit`


library(ggbeeswarm)
tTest_gene_final$Type2 <- factor(
  tTest_gene_final$Type2,
  levels = c("NonPathogens", "Pathogens")
)


p1 <- ggplot(data = tTest_gene_final[,], aes(x = Type2, y = Freq, fill = Type2)) +
  facet_wrap(~GeneKind, scales = "free_y", nrow = 1) +
  geom_quasirandom(width = 0.2, alpha = 0.2, size = 0.2, aes(color=Type2))+

  # geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.2, size = 0.3, width = 0.5) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 2.5, color = "black") +
  stat_compare_means(
    comparisons = list(c("NonPathogens", "Pathogens")),
    method = "wilcox.test",
    label = "p.signif",
    size = 3, vjust = 0.5
  ) +
  scale_y_continuous(trans = "sqrt", labels = scales::scientific) +  # ğŸ”¹å¹³æ–¹æ ¹æˆ–æ”¹ä¸º log10
  scale_color_manual(values = pathogen_colors2) +
  theme_jgfbw() +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12)
  ) +
  xlab("")+
  ylab("Genome-normalized gene frequency")
p1

# ggsave(filename = "03.figure/S_biopollutome_compare.pdf",height = 3.6,width = 12)

tTest_gene_final$Type.x %>% unique()
tTest_gene_final$Type.x <- factor(
  tTest_gene_final$Type.x,
  levels = c("NonPathogens", "Plant", "Animal", "Zoonotic")
)


head(tTest_gene_final)

library(ggbeeswarm)
p2 <- ggplot(data = tTest_gene_final[,], aes(x = Type.x, y = Freq, fill = Type.x)) +
  facet_wrap(~GeneKind, scales = "free_y", nrow = 1) +
  geom_quasirandom(width = 0.2, alpha = 0.2, size = 0.2, aes(color=Type.x))+

  # geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.2, size = 0.3, width = 0.5) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 2.5, color = "black") +
  stat_compare_means(
    # comparisons = list(c("Zoonotic", "Animal"),c("Animal", "Plant"),c("Plant", "NonPathogens")),
    comparisons = list(c("Zoonotic", "Animal"),c("Animal", "Plant"),c("Plant", "NonPathogens"),c("Plant", "Zoonotic")),
    # comparisons = list(c("Zoonotic", "Plant")),

    method = "wilcox.test",
    label = "p.signif",
    size = 3, vjust = 0.5
  ) +
  scale_y_continuous(trans = "sqrt", labels = scales::scientific) +  # ğŸ”¹å¹³æ–¹æ ¹æˆ–æ”¹ä¸º log10
  theme_jgfbw() +
  scale_color_manual(values = pathogen_color3) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12)
  ) +
  xlab("")+
  ylab("Genome-normalized gene frequency")
p2

p1/p2+plot_annotation(tag_levels = "a")&
  theme(plot.title = element_text(face = "bold"),
        plot.tag = element_text(face = "bold"))

 
ggsave(filename = "03.figure/S_biopollutome_compare.pdf",height = 6,width = 15)


# åˆå¹¶æ‰€æœ‰Geneçš„ç‰ˆæœ¬
tTest_gene_final2$Type.x %>% unique()
tTest_gene_final2$Type.x <- factor(
  tTest_gene_final2$Type.x,
  levels = c("NonPathogens", "Plant", "Animal", "Zoonotic")
)

library(ggbeeswarm)
p2 <- ggplot(data = tTest_gene_final2[,], aes(x = Type.x, y = Freq, fill = Type.x)) +
  facet_wrap(~GeneKind, scales = "free_y", nrow = 1) +
  geom_quasirandom(width = 0.2, alpha = 0.2, size = 0.2, aes(color=Type.x))+

  # geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.2, size = 0.3, width = 0.5) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 2.5, color = "black") +
  stat_compare_means(
    # comparisons = list(c("Zoonotic", "Animal"),c("Animal", "Plant"),c("Plant", "NonPathogens")),
    comparisons = list(c("Zoonotic", "Plant")),

    method = "wilcox.test",
    label = "p.signif",
    size = 3, vjust = 0.5
  ) +
  scale_y_continuous(trans = "sqrt", labels = scales::scientific) +  # ğŸ”¹å¹³æ–¹æ ¹æˆ–æ”¹ä¸º log10
  theme_jgfbw() +
  scale_color_manual(values = pathogen_color3) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12)
  ) +
  xlab("")+
  ylab("Genome-normalized gene frequency")
p2



```

# ç»Ÿè®¡-åŠŸèƒ½åŸºå› å·®å¼‚åˆ†æ
```{r}

head(tTest_gene_final)
# freqæ˜¾è‘—æ€§å·®å¼‚åˆ†æ
library(dplyr)
library(rstatix)

# è®¡ç®—æ¯ç±»åŸºå› åœ¨ Pathogen ä¸ NonPathogen ä¸­çš„å¹³å‡ Freq
group_summary <- tTest_gene_final %>%
  group_by(GeneKind, Type2) %>%
  summarise(mean_Freq = mean(Freq, na.rm = TRUE),
            sd_Freq = sd(Freq, na.rm = TRUE),
            .groups = "drop")
group_summary

# åˆå¹¶æ˜¾è‘—æ€§æ£€éªŒç»“æœ
compare_results2 <- tTest_gene_final %>%
  group_by(GeneKind) %>%
  t_test(Freq ~ Type2, var.equal = FALSE) %>%
  adjust_pvalue(method = "BH") %>%
  mutate(signif = case_when(
    p.adj < 0.001 ~ "***",
    p.adj < 0.01 ~ "**",
    p.adj < 0.05 ~ "*",
    TRUE ~ "ns"
  ))
compare_results

```

# æ•°æ®åº“ç™¾åˆ†æ¯”å•é¥¼å›¾ï¼ˆType and Phylumï¼‰

```{r}


# dataframe:é•¿å‹è¡¨
# valueï¼šå­—ç¬¦ä¸²,dfä¸­éœ€è¦è®¡ç®—æ¯”ä¾‹çš„valueä¸€åˆ—
# labelï¼šå­—ç¬¦ä¸²,æ ‡ç­¾åˆ—ï¼Œæˆ–è€…æ˜¯IDåˆ—
pie_df <- function(dataframe,value,label){
  df <- dataframe
  colnames(df)[which(colnames(df) %in% value )] <- "value"
  colnames(df)[which(colnames(df) %in% label )] <- "ID"
  # ç©ºå¿ƒé¥¼å›¾
  df$fraction<-df$value/sum(df$value)
  df$ymax<-cumsum(df$fraction)
  df$ymin<-c(0,head(df$ymax,n=-1))
  df$percent <- paste0(round(df$fraction,4)*100,"%")
  df$label <- paste(df$ID,df$percent)
  return(df)
}
# ä½¿ç”¨æ–¹æ³•
# DB_type <- pie_df(dataframe = DB_type,value ="Freq",label = "x" )

attach(final_bio_risk)
final_ARGs <- final_bio_risk %>% filter(GeneKind=="ARGs")
final_MGEs <- final_bio_risk %>% filter(GeneKind=="MGEs")
final_MRGs <- final_bio_risk %>% filter(GeneKind=="MRGs")
final_VFs <- final_bio_risk %>% filter(GeneKind=="VFs")
final_SGs <- final_bio_risk %>% filter(GeneKind=="SGs")

uniq_c(final_bio_risk$GeneKind)



# é¥¼å›¾ Typeç»„æˆ
df <- list(ARGs=final_ARGs,MGEs=final_MGEs,MRGs=final_MRGs,VFs=final_VFs,SGs=final_SGs)
for (i in c(1:5)) {
  DB <- df[[i]]
  level <- names(df[i])
  
  DB_name <- names(df)[[i]]
  DB_type <- uniq_c(DB$GeneType)
  DB_type$ID <- as.character(DB_type$ID)
  DB_type$ID[which(DB_type$ID=='macrolide-lincosamide-streptogramin')] <- "MLS"
  DB_type$ID <- str_to_title(DB_type$ID) #é¦–å­—æ¯å¤§å†™
  # topå‰10çš„Type
  if (nrow(DB_type)>5) {
    Top <- 8
    DB_other <- data.frame(ID="Others",Count=as.numeric(sum(DB_type$Count[Top:nrow(DB_type)])))
    DB_type <- rbind(DB_type[1:Top,],DB_other)
    DB_type <- aggregate(DB_type[,-1],by = list(DB_type$ID),FUN = "sum")
    colnames(DB_type) <- c("ID","Count")
  }else{
    DB_type <- DB_type
  }
  colnames(DB_type) <- c("ID","value")
  # è®¡ç®—ç™¾åˆ†æ•°
  DB_type_pre <- pie_df(dataframe = DB_type,value ="value",label = "ID" )
  DB_type_pre <- arrange(DB_type_pre, desc(value))
  DB_type_pre$label <- factor( DB_type_pre$label,levels =  DB_type_pre$label)
  # å¯è§†åŒ–
  plot <- ggplot(DB_type_pre,aes(ymax=ymax,ymin=ymin,xmax=4,xmin=3))+
  geom_rect(aes(fill=label))+
  theme_bw()+
  xlim(2,4)+
  scale_fill_simpsons(palette = "springfield")+
  coord_polar(theta="y")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(), 
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title=element_blank(), 
        legend.position = "right",
        legend.key.size = unit(0.5, 'lines'),
        panel.border = element_blank(),
        panel.background = element_blank())+#å»é™¤æ²¡ç”¨çš„ggplotèƒŒæ™¯ï¼Œåæ ‡è½´
  xlab('')+ylab('')+
  guides(fill=guide_legend( ncol=1))
  barnname=paste0("03.figure/Sfigure/Pie_state_Type_", DB_name)
  plotname <- paste0("Pie_T_", DB_name)
  assign(plotname,plot,envir = .GlobalEnv)
  ggsave(plot,file=paste(barnname,".pdf",sep=""),width = 6,height = 2.5) 
  
}


# é¥¼å›¾ï¼ˆç—…åŸèŒç»„æˆï¼‰
df <- list(ARGs=final_ARGs,MGEs=final_MGEs,MRGs=final_MRGs,VFs=final_VFs,SGs=final_SGs)
for (i in c(1:5)) {
  DB <- df[[i]]
  level <- names(df[i])
  
  DB_name <- names(df)[[i]]
  DB_type <- uniq_c(DB$Type)
  DB_type$ID <- as.character(DB_type$ID)
  DB_type$ID[which(DB_type$Count=='macrolide-lincosamide-streptogramin')] <- "MLS"
  DB_type$ID <- str_to_title(DB_type$ID) #é¦–å­—æ¯å¤§å†™
  # topå‰10çš„Type
  if (nrow(DB_type)>4) {
    Top <- 10
    DB_other <- data.frame(x="Others",Freq=as.numeric(sum(DB_type$Freq[Top:nrow(DB_type)])))
    DB_type <- rbind(DB_type[1:10,],DB_other)
    DB_type <- aggregate(DB_type[,-1],by = list(DB_type$Count),FUN = "sum")
    colnames(DB_type) <- c("ID","Count")
  }else{
    DB_type <- DB_type
  }
  colnames(DB_type) <- c("ID","value")
  # è®¡ç®—ç™¾åˆ†æ•°
  DB_type_pre <- pie_df(dataframe = DB_type,value ="value",label = "ID" )
  DB_type_pre <- arrange(DB_type_pre, desc(value))
  DB_type_pre$label <- factor( DB_type_pre$label,levels =  DB_type_pre$label)
  # å¯è§†åŒ–
  plot <- ggplot(DB_type_pre,aes(ymax=ymax,ymin=ymin,xmax=4,xmin=3))+
  geom_rect(aes(fill=label))+
  theme_bw()+
  xlim(2,4)+
  scale_fill_simpsons(palette = "springfield")+
  coord_polar(theta="y")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(), 
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title=element_blank(), 
        legend.position = "right",
        legend.key.size = unit(0.5, 'lines'),
        panel.border = element_blank(),
        panel.background = element_blank())+#å»é™¤æ²¡ç”¨çš„ggplotèƒŒæ™¯ï¼Œåæ ‡è½´
  xlab('')+ylab('')+
  guides(fill=guide_legend( ncol=1))
  barnname=paste0("03.figure/Sfigure/Pie_state_PA_", DB_name)
  plotname <- paste0("Pie_PA_", DB_name)
  assign(plotname,plot,envir = .GlobalEnv)
  ggsave(plot,file=paste(barnname,".pdf",sep=""),width = 6,height = 2.5) 
  
}



# é¥¼å›¾ï¼ˆPhylumç»„æˆï¼‰
df <- list(ARGs=final_ARGs,MGEs=final_MGEs,MRGs=final_MRGs,VFs=final_VFs,SGs=final_SGs)
for (i in c(1:5)) {
  DB <- df[[i]]
  level <- names(df[i])
  
  DB_name <- names(df)[[i]]
  DB_Phylum <- uniq_c(DB$Phylum)
  DB_Phylum$ID <- as.character(DB_Phylum$ID)
  DB_Phylum$ID <- str_to_title(DB_Phylum$ID) #é¦–å­—æ¯å¤§å†™
  # topå‰10çš„Phylum
  if (nrow(DB_Phylum)>5) {
    Top <- 5
    DB_other <- data.frame(ID="Other",Count=as.numeric(sum(DB_Phylum$value[Top:nrow(DB_Phylum)])))
    DB_Phylum <- rbind(DB_Phylum[1:Top,],DB_other)
  }else{
    DB_Phylum <- DB_Phylum
  }
  colnames(DB_Phylum) <- c("ID","value")
  # è®¡ç®—ç™¾åˆ†æ•°
  DB_Phylum_pre <- pie_df(dataframe = DB_Phylum,value ="value",label = "ID" )
  DB_Phylum_pre <- arrange(DB_Phylum_pre, desc(value))
  DB_Phylum_pre$label <- factor( DB_Phylum_pre$label,levels =  DB_Phylum_pre$label)
  # å¯è§†åŒ–
  plot <- ggplot(DB_Phylum_pre,aes(ymax=ymax,ymin=ymin,xmax=4,xmin=3))+
  geom_rect(aes(fill=label))+
  theme_bw()+
  xlim(2,4)+
  scale_fill_simpsons(palette = "springfield")+
  coord_polar(theta="y")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(), 
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.title=element_blank(), 
        legend.position = "right",
        legend.key.size = unit(0.5, 'lines'),
        panel.border = element_blank(),
        panel.background = element_blank())+#å»é™¤æ²¡ç”¨çš„ggplotèƒŒæ™¯ï¼Œåæ ‡è½´
  xlab('')+ylab('')+
  guides(fill=guide_legend( ncol=1))
  barnname=paste0("03.figure/Sfigure/Pie_state_Phylum_", DB_name)
  plotname <- paste0("Pie_P_", DB_name)
  assign(plotname,plot,envir = .GlobalEnv)
  ggsave(plot,file=paste(barnname,".pdf",sep=""),width = 6,height = 2.5) 
  
}



final <- Pie_T_ARGs/Pie_T_MGEs/Pie_T_MRGs/Pie_T_VFs/Pie_T_SGs + plot_layout(guides = 'collect')
final

final2 <- Pie_P_ARGs/Pie_P_MGEs/Pie_P_MRGs/Pie_P_VFs/Pie_P_SGs+ plot_layout(guides = 'collect')
final2

# final
# final2
final+final2


# è®¾ç½®è®¾è®¡å›¾å±‚
design1 <- "
ABCDE
FGHIJ
"

design2 <- "
ABCDE
FGHIJ
"

# ç¡®ä¿æ¯ä¸ªé¥¼å›¾çš„æ¯”ä¾‹æ˜¯1:1ï¼ˆå³åœ†å½¢ï¼‰ï¼Œå¹¶ç¡®ä¿å¤§å°ä¸€è‡´
Pie_T_ARGs <- Pie_T_ARGs + theme(aspect.ratio = 1) 
Pie_T_MGEs <- Pie_T_MGEs + theme(aspect.ratio = 1)
Pie_T_MRGs <- Pie_T_MRGs + theme(aspect.ratio = 1)
Pie_T_VFs <- Pie_T_VFs + theme(aspect.ratio = 1)
Pie_T_SGs <- Pie_T_SGs + theme(aspect.ratio = 1)

Pie_P_ARGs <- Pie_P_ARGs + theme(aspect.ratio = 1)
Pie_P_MGEs <- Pie_P_MGEs + theme(aspect.ratio = 1)
Pie_P_MRGs <- Pie_P_MRGs + theme(aspect.ratio = 1)
Pie_P_VFs <- Pie_P_VFs + theme(aspect.ratio = 1)
Pie_P_SGs <- Pie_P_SGs + theme(aspect.ratio = 1)


final <- Pie_T_ARGs/Pie_T_MGEs/Pie_T_MRGs/Pie_T_VFs/Pie_T_SGs + plot_layout(design = design1, guides = 'collect')
final2 <- Pie_P_ARGs/Pie_P_MGEs/Pie_P_MRGs/Pie_P_VFs/Pie_P_SGs + plot_layout(design = design2, guides = 'collect')

# åˆå¹¶å›¾å½¢
Final <- final + final2
Final <- Pie_T_ARGs/Pie_T_MGEs/Pie_T_MRGs/Pie_T_VFs/Pie_T_SGs/Pie_P_ARGs/Pie_P_MGEs/Pie_P_MRGs/Pie_P_VFs/Pie_P_SGs+
    plot_layout(ncol = 5)&theme(legend.position = "bottom")&
  plot_annotation(tag_levels = "a")&theme(plot.margin = ggplot2::margin(0, .1, 0, .1),)&
  theme(plot.title = element_text(face = "bold"),
        plot.tag = element_text(face = "bold"))
Final
ggsave(Final,file="03.figure/Sfigure/Pie_final.pdf",width = 12,height = 10) 

```




